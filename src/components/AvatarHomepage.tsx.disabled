import React, { useState, useEffect, useRef } from 'react';
import {
  Sun, Cloud, CloudRain, Snowflake, ArrowLeft, ArrowRight, RefreshCw,
  Edit, Settings, Thermometer, Wind, Eye, Calendar,
  Shirt, Palette, User, AlertCircle, Loader, MapPin, Clock,
  TrendingUp, Sparkles, Camera, Share2, ShoppingCart, Heart,
  RotateCcw, Trash2, ArrowRightCircle
} from 'lucide-react';
import { weatherService, WeatherData } from '../services/weatherService';
import { outfitGenerationService, OutfitSuggestion, StyleProfile } from '../services/outfitGenerationService'; // v2.0.0 FAL integration
import { avatarAnimationService, AnimationType } from '../services/avatarAnimationService';
import { UserData } from '../types/user';
import UserService from '../services/userService';
import ClosetService, { ClothingCategory } from '../services/closetService';
import webEnhancedPromptService, { PromptVariation } from '../services/webEnhancedPromptService';
import WebEnhancedPromptModal from './WebEnhancedPromptModal';
import SaveToClosetModal, { SavedItemData } from './SaveToClosetModal';
import seamlessTryOnService, { SeamlessTryOnResult, TryOnProgress } from '../services/seamlessTryOnService';

interface AvatarHomepageProps {
  onBack: () => void;
  onNavigateToOutfitChange?: () => void;
  onNavigateToMeasurements?: () => void;
  onNavigateToStyleProfile?: () => void;
  onNavigateToCloset?: () => void;
  onAvatarUpdate?: (avatarData: any) => void;
  avatarData?: any;
  userData?: UserData | null;
  styleProfile?: StyleProfile;
}

// Wishlist item interface
interface WishlistItem {
  id: string;
  imageUrl: string;
  notes: string;
  dateAdded: string;
  fromPrompt: string;
  category?: string;
  name?: string;
}

const AvatarHomepage: React.FC<AvatarHomepageProps> = ({
  onBack,
  onNavigateToOutfitChange,
  onNavigateToMeasurements,
  onNavigateToStyleProfile,
  onNavigateToCloset,
  onAvatarUpdate,
  avatarData,
  userData,
  styleProfile
}) => {
  const [currentTime, setCurrentTime] = useState(new Date());
  const [weather, setWeather] = useState<WeatherData | null>(null);
  const [weatherLoading, setWeatherLoading] = useState(true);
  const [weatherError, setWeatherError] = useState<string | null>(null);
  const [isGeneratingOutfits, setIsGeneratingOutfits] = useState(false);
  const [outfitSuggestions, setOutfitSuggestions] = useState<OutfitSuggestion[]>([]);
  const [selectedOutfit, setSelectedOutfit] = useState<number | null>(null);
  const [avatarAnimation, setAvatarAnimation] = useState<AnimationType>('floatingBreath');
  const [applyingOutfit, setApplyingOutfit] = useState(false);
  const [uploadingClothing, setUploadingClothing] = useState(false);
  const [uploadPreview, setUploadPreview] = useState<string | null>(null);
  const [showUploadModal, setShowUploadModal] = useState(false);
  const [selectedCategory, setSelectedCategory] = useState<ClothingCategory>('tops');
  const [clothingName, setClothingName] = useState('');
  const [clothingDescription, setClothingDescription] = useState('');
  const [showRefreshModal, setShowRefreshModal] = useState(false);
  const [refreshMode, setRefreshMode] = useState<'smart' | 'seasonal' | 'color' | 'occasion'>('smart');
  const [userPreferences, setUserPreferences] = useState({
    likedOutfits: [] as number[],
    skippedOutfits: [] as number[],
    preferredStyles: [] as string[],
    preferredColors: [] as string[]
  });
  const [outfitPrompt, setOutfitPrompt] = useState('');
  const [selectedStyle, setSelectedStyle] = useState<'casual' | 'formal' | 'trendy' | 'vintage' | 'minimalist' | 'edgy'>('casual');

  // Web-enhanced prompt modal state
  const [showWebEnhancedModal, setShowWebEnhancedModal] = useState(false);
  const [webEnhancedVariations, setWebEnhancedVariations] = useState<PromptVariation[]>([]);
  const [isGeneratingWebVariations, setIsGeneratingWebVariations] = useState(false);

  // Save to closet modal state
  const [showSaveToClosetModal, setShowSaveToClosetModal] = useState(false);
  const [pendingSaveImage, setPendingSaveImage] = useState<string | null>(null);
  const [pendingSavePrompt, setPendingSavePrompt] = useState<string>('');
  const [isGeneratingCustomOutfit, setIsGeneratingCustomOutfit] = useState(false);
  const [generatedOutfit, setGeneratedOutfit] = useState<any>(null);
  const [outfitPreviewImage, setOutfitPreviewImage] = useState<string | null>(null);
  const [multipleOutfitImages, setMultipleOutfitImages] = useState<Array<{ url: string; prompt: string; variation: string }> | null>(null);
  const [showImageSelection, setShowImageSelection] = useState(false);
  const [isGeneratingMultiple, setIsGeneratingMultiple] = useState(false);

  // Wishlist state
  const [wishlistItems, setWishlistItems] = useState<WishlistItem[]>([]);
  const [activeView, setActiveView] = useState<'closet' | 'wishlist'>('closet');

  // Seamless try-on state
  const [isSeamlessTryOn, setIsSeamlessTryOn] = useState(false);
  const [tryOnProgress, setTryOnProgress] = useState<TryOnProgress | null>(null);
  const [seamlessTryOnResult, setSeamlessTryOnResult] = useState<SeamlessTryOnResult | null>(null);

  // New layout state
  const [showOutfitPreviewSlideIn, setShowOutfitPreviewSlideIn] = useState(false);
  const [showWishlistTab, setShowWishlistTab] = useState(false);
  const [previewOutfit, setPreviewOutfit] = useState<{
    imageUrl: string;
    description: string;
    category?: string;
  } | null>(null);

  // DEBUG: Track outfitPreviewImage state changes
  useEffect(() => {
    console.log('üîç [STATE-DEBUG] outfitPreviewImage changed:', {
      hasImage: !!outfitPreviewImage,
      imageType: outfitPreviewImage?.startsWith('data:image/svg') ? 'svg' : outfitPreviewImage?.startsWith('data:') ? 'base64' : outfitPreviewImage?.startsWith('http') ? 'url' : 'none',
      length: outfitPreviewImage?.length || 0,
      timestamp: new Date().toLocaleTimeString()
    });
  }, [outfitPreviewImage]);

  // UTF-8 safe base64 encoding helper
  const utf8ToBase64 = (str: string): string => {
    try {
      // First try standard btoa for ASCII content
      return btoa(str);
    } catch (error) {
      console.log('üîÑ [ENCODING] Using UTF-8 safe encoding fallback in component');
      try {
        // UTF-8 safe encoding
        return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
          (match, p1) => String.fromCharCode(parseInt('0x' + p1, 16))));
      } catch (finalError) {
        console.error('‚ùå [ENCODING] All encoding methods failed in component:', finalError);
        throw new Error('Failed to encode SVG content');
      }
    }
  };
  const [showOutfitPreview, setShowOutfitPreview] = useState(false);
  const [isApplyingOutfitToAvatar, setIsApplyingOutfitToAvatar] = useState(false);
  const avatarRef = useRef<HTMLDivElement>(null);
  const outfitPreviewRef = useRef<HTMLDivElement>(null);

  // Update time every minute
  useEffect(() => {
    const timer = setInterval(() => {
      setCurrentTime(new Date());
    }, 60000);

    return () => clearInterval(timer);
  }, []);

  // Debug: Log avatar data changes
  useEffect(() => {
    console.log('üé≠ Avatar image check:', {
      hasAvatarData: !!avatarData,
      imageUrl: avatarData?.imageUrl,
      withOutfit: avatarData?.withOutfit,
      outfitDetails: avatarData?.outfitDetails
    });
  }, [avatarData]);

  // Fetch real weather data
  useEffect(() => {
    const fetchWeather = async () => {
      setWeatherLoading(true);
      setWeatherError(null);

      try {
        const weatherData = await weatherService.getCurrentWeather();
        setWeather(weatherData);
      } catch (error) {
        setWeatherError('Failed to load weather data');
        console.error('Weather fetch error:', error);
        // Set fallback weather data to ensure page still works
        setWeather({
          temperature: 70,
          condition: 'rainy',
          humidity: 60,
          windSpeed: 5,
          location: 'Los Angeles, CA'
        });
      } finally {
        setWeatherLoading(false);
      }
    };

    fetchWeather();

    // Refresh weather every 10 minutes
    const weatherTimer = setInterval(fetchWeather, 10 * 60 * 1000);
    return () => clearInterval(weatherTimer);
  }, []);

  // Load wishlist from localStorage on component mount
  useEffect(() => {
    try {
      const savedWishlist = localStorage.getItem('fitChecked_wishlist');
      if (savedWishlist) {
        setWishlistItems(JSON.parse(savedWishlist));
        console.log('üìã [WISHLIST] Loaded wishlist from localStorage');
      }
    } catch (error) {
      console.error('‚ùå [WISHLIST] Failed to load wishlist from localStorage:', error);
    }
  }, []);

  // Generate outfit suggestions based on weather and style
  useEffect(() => {
    if (weather) {
      generateOutfitSuggestions().catch(error => {
        console.warn('Outfit generation failed, using fallback data:', error);
      });
    }
  }, [weather, styleProfile]);

  const getGreeting = () => {
    const personalizedGreeting = UserService.getPersonalizedGreeting(userData);
    return personalizedGreeting.message;
  };

  // Handle file upload with image processing
  const handleFileUpload = async (file: File) => {
    if (!file) return;

    setUploadingClothing(true);

    try {
      // Create preview URL
      const previewUrl = URL.createObjectURL(file);
      setUploadPreview(previewUrl);

      // Auto-detect category from filename
      const detectedCategory = ClosetService.autoDetectCategory(file.name);
      setSelectedCategory(detectedCategory);

      // Auto-generate name from filename
      const baseName = file.name.replace(/\.[^/.]+$/, "").replace(/[-_]/g, ' ');
      setClothingName(baseName.charAt(0).toUpperCase() + baseName.slice(1));

      // Show upload modal for confirmation/editing
      setShowUploadModal(true);
    } catch (error) {
      console.error('Error processing uploaded file:', error);
      alert('Error processing uploaded file. Please try again.');
    } finally {
      setUploadingClothing(false);
    }
  };

  // Process and save clothing item to closet
  const saveClothingToCloset = async () => {
    if (!uploadPreview) return;

    setUploadingClothing(true);

    try {
      // Save to closet service
      const savedItem = await ClosetService.saveClothingItem(
        uploadPreview,
        selectedCategory,
        clothingName || `New ${selectedCategory}`,
        clothingDescription
      );

      console.log('‚úÖ Clothing saved to closet:', savedItem);

      // Show success feedback
      alert(`Successfully added "${savedItem.name}" to your ${selectedCategory} collection!`);

      // Reset state
      setShowUploadModal(false);
      setUploadPreview(null);
      setClothingName('');
      setClothingDescription('');

      // Optionally apply to avatar immediately
      if (onTryOnItem) {
        await onTryOnItem(savedItem);
      }
    } catch (error) {
      console.error('Error saving clothing to closet:', error);
      alert('Error saving clothing. Please try again.');
    } finally {
      setUploadingClothing(false);
    }
  };

  // Try on item interface for upload workflow
  interface TryOnItem {
    id: string;
    name: string;
    imageUrl: string;
    category: ClothingCategory;
  }

  const onTryOnItem = async (item: TryOnItem) => {
    setApplyingOutfit(true);
    try {
      // TODO: Integrate with virtual try-on service
      console.log('üéØ Trying on uploaded item:', item.name);

      // Simulate try-on process
      setAvatarAnimation('changing');
      setTimeout(() => {
        setAvatarAnimation('posing');
        console.log('‚ú® Virtual try-on complete!');
      }, 2000);

    } catch (error) {
      console.error('Error trying on item:', error);
    } finally {
      setApplyingOutfit(false);
    }
  };

  // Smart upload with drag and drop support
  const handleSmartUpload = () => {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.multiple = false;
    input.onchange = (event) => {
      const file = (event.target as HTMLInputElement).files?.[0];
      if (file) {
        handleFileUpload(file);
      }
    };
    input.click();
  };

  // Load user preferences from localStorage
  useEffect(() => {
    const savedPreferences = localStorage.getItem('userOutfitPreferences');
    if (savedPreferences) {
      try {
        setUserPreferences(JSON.parse(savedPreferences));
      } catch (error) {
        console.error('Error loading user preferences:', error);
      }
    }
  }, []);

  // Save user preferences to localStorage
  const saveUserPreferences = (preferences: typeof userPreferences) => {
    localStorage.setItem('userOutfitPreferences', JSON.stringify(preferences));
    setUserPreferences(preferences);
  };

  // Track user outfit preferences
  const handleOutfitLike = (outfitId: number) => {
    const outfit = outfitSuggestions.find(o => o.id === outfitId);
    if (outfit) {
      const newPreferences = {
        ...userPreferences,
        likedOutfits: [...userPreferences.likedOutfits, outfitId],
        preferredStyles: [...new Set([...userPreferences.preferredStyles, outfit.style])],
        preferredColors: [...new Set([...userPreferences.preferredColors, ...outfit.colors])]
      };
      saveUserPreferences(newPreferences);
    }
  };

  const handleOutfitSkip = (outfitId: number) => {
    const newPreferences = {
      ...userPreferences,
      skippedOutfits: [...userPreferences.skippedOutfits, outfitId]
    };
    saveUserPreferences(newPreferences);
  };

  // Smart refresh with different modes
  const handleSmartRefresh = async (mode: 'smart' | 'seasonal' | 'color' | 'occasion' = 'smart') => {
    if (!weather) return;

    setIsGeneratingOutfits(true);

    try {
      const now = new Date();
      const month = now.getMonth() + 1;
      const hour = now.getHours();

      let timeOfDay: 'morning' | 'afternoon' | 'evening' | 'night' = 'afternoon';
      if (hour >= 5 && hour < 12) timeOfDay = 'morning';
      else if (hour >= 12 && hour < 17) timeOfDay = 'afternoon';
      else if (hour >= 17 && hour < 21) timeOfDay = 'evening';
      else timeOfDay = 'night';

      let season: 'spring' | 'summer' | 'fall' | 'winter' = 'spring';
      if (month >= 3 && month <= 5) season = 'spring';
      else if (month >= 6 && month <= 8) season = 'summer';
      else if (month >= 9 && month <= 11) season = 'fall';
      else season = 'winter';

      // Enhanced style profile with user preferences
      const enhancedStyleProfile = {
        ...styleProfile,
        fashionPersonality: {
          ...styleProfile?.fashionPersonality,
          preferredStyles: [...new Set([
            ...(styleProfile?.fashionPersonality?.preferredStyles || []),
            ...userPreferences.preferredStyles
          ])],
          colorPalette: [...new Set([
            ...(styleProfile?.fashionPersonality?.colorPalette || []),
            ...userPreferences.preferredColors
          ])]
        }
      };

      // Check if user has items in their closet
      const userClosetStats = ClosetService.getClosetStats();
      const hasClothingItems = userClosetStats.totalItems > 0;

      // Generate suggestions based on mode
      let occasionOverride = undefined;
      if (mode === 'occasion') {
        const occasions = ['casual', 'work', 'date night', 'weekend', 'social'];
        occasionOverride = occasions[Math.floor(Math.random() * occasions.length)];
      }

      const suggestions = await outfitGenerationService.generateOutfitSuggestions({
        weather,
        styleProfile: enhancedStyleProfile,
        avatarImageUrl: avatarData?.imageUrl || avatarData,
        numberOfSuggestions: 3,
        timeOfDay: '', // Not used for direct prompts
        season,
        month,
        usePersonalWardrobe: hasClothingItems,
        occasion: occasionOverride
      });

      // Filter out previously skipped outfits if in smart mode
      let filteredSuggestions = suggestions;
      if (mode === 'smart' && userPreferences.skippedOutfits.length > 0) {
        filteredSuggestions = suggestions.filter(suggestion =>
          !userPreferences.skippedOutfits.some(skippedId =>
            suggestion.name === outfitSuggestions.find(o => o.id === skippedId)?.name
          )
        );
      }

      // Boost suggestions that match user preferences
      if (mode === 'smart' && userPreferences.preferredStyles.length > 0) {
        filteredSuggestions = filteredSuggestions.sort((a, b) => {
          const aScore = userPreferences.preferredStyles.includes(a.style) ? 1 : 0;
          const bScore = userPreferences.preferredStyles.includes(b.style) ? 1 : 0;
          return bScore - aScore;
        });
      }

      setOutfitSuggestions(filteredSuggestions);
      console.log(`üéØ Generated ${filteredSuggestions.length} outfits in ${mode} mode`);

    } catch (error) {
      console.error('Failed to generate outfit suggestions:', error);
      // Keep existing fallback logic
    } finally {
      setIsGeneratingOutfits(false);
    }
  };

  // Generate custom outfit from user prompt

  // Handle web-enhanced prompt preview generation
  const handleWebEnhancedPrompts = async () => {
    if (!outfitPrompt.trim()) {
      console.error('‚ùå [WEB-ENHANCED] Missing outfit prompt');
      alert('Please enter an outfit description first');
      return;
    }

    console.log('üåê [WEB-ENHANCED] Starting web-enhanced prompt generation...');

    // Show modal and start loading
    setShowWebEnhancedModal(true);
    setIsGeneratingWebVariations(true);
    setWebEnhancedVariations([]);

    try {
      // Generate web-enhanced variations
      const variations = await webEnhancedPromptService.generateThreePromptVariations(
        outfitPrompt,
        selectedStyle
      );

      setWebEnhancedVariations(variations);
      setIsGeneratingWebVariations(false);

      console.log('‚úÖ [WEB-ENHANCED] Generated web-enhanced variations:', variations);
    } catch (error) {
      console.error('‚ùå [WEB-ENHANCED] Failed:', error);
      setIsGeneratingWebVariations(false);
      alert('Failed to generate web-enhanced prompts. Please try again.');
      setShowWebEnhancedModal(false);
    }
  };

  // Handle selection of a web-enhanced variation
  const handleSelectWebEnhancedVariation = (variation: PromptVariation) => {
    console.log('üéØ [WEB-ENHANCED] User selected variation:', variation.title);

    // Update the prompt input with the selected variation
    setOutfitPrompt(variation.prompt);

    // Close modal
    setShowWebEnhancedModal(false);

    console.log('‚úÖ [WEB-ENHANCED] Updated prompt with web-enhanced variation');
  };

  // Handle saving generated item to closet
  const handleSaveToCloset = async (itemData: SavedItemData) => {
    console.log('üíæ [SAVE-CLOSET] Saving item to closet:', itemData);

    try {
      // Add the item to the appropriate category in ClosetService
      await ClosetService.addClothingItem(itemData.category as ClothingCategory, {
        id: itemData.id,
        name: itemData.name,
        imageUrl: itemData.imageUrl,
        description: itemData.originalPrompt || '',
        isUserGenerated: true,
        dateAdded: itemData.dateAdded,
        source: itemData.source
      });

      console.log('‚úÖ [SAVE-CLOSET] Successfully saved to closet');
      alert('Item saved to your closet!');
    } catch (error) {
      console.error('‚ùå [SAVE-CLOSET] Failed to save to closet:', error);
      alert('Failed to save item to closet. Please try again.');
    }
  };

  // Handle adding generated item to wishlist
  const handleAddToWishlist = async (itemData: SavedItemData) => {
    console.log('üíù [SAVE-WISHLIST] Adding item to wishlist:', itemData);

    try {
      const wishlistItem: WishlistItem = {
        id: `wishlist_${Date.now()}`,
        imageUrl: itemData.imageUrl,
        notes: itemData.name,
        dateAdded: new Date().toISOString(),
        fromPrompt: itemData.originalPrompt || '',
        category: itemData.category,
        name: itemData.name
      };

      const updatedWishlist = [...wishlistItems, wishlistItem];
      setWishlistItems(updatedWishlist);

      // Save to localStorage
      localStorage.setItem('fitChecked_wishlist', JSON.stringify(updatedWishlist));

      console.log('‚úÖ [SAVE-WISHLIST] Successfully added to wishlist');
      alert('Item added to your wishlist!');
    } catch (error) {
      console.error('‚ùå [SAVE-WISHLIST] Failed to add to wishlist:', error);
      alert('Failed to add item to wishlist. Please try again.');
    }
  };

  // Move wishlist item to closet
  const handleMoveToCloset = async (wishlistItem: WishlistItem) => {
    console.log('üì¶ [WISHLIST] Moving item to closet:', wishlistItem);

    try {
      // Add to closet
      await ClosetService.addClothingItem(wishlistItem.category as ClothingCategory || 'tops', {
        id: Date.now(),
        name: wishlistItem.name || 'Wishlist Item',
        imageUrl: wishlistItem.imageUrl,
        description: `Moved from wishlist: ${wishlistItem.fromPrompt}`,
        isUserGenerated: true,
        dateAdded: new Date().toISOString(),
        source: 'generated'
      });

      // Remove from wishlist
      const updatedWishlist = wishlistItems.filter(item => item.id !== wishlistItem.id);
      setWishlistItems(updatedWishlist);
      localStorage.setItem('fitChecked_wishlist', JSON.stringify(updatedWishlist));

      console.log('‚úÖ [WISHLIST] Successfully moved to closet');
      alert('Item moved to your closet!');
    } catch (error) {
      console.error('‚ùå [WISHLIST] Failed to move to closet:', error);
      alert('Failed to move item to closet. Please try again.');
    }
  };

  // Generate similar outfit from wishlist item
  const handleGenerateSimilar = async (wishlistItem: WishlistItem) => {
    console.log('üîÑ [WISHLIST] Generating similar outfit for:', wishlistItem);

    try {
      setIsGeneratingCustomOutfit(true);
      setOutfitPrompt(wishlistItem.fromPrompt);

      const outfitSuggestion = await outfitGenerationService.generateCustomOutfit({
        userRequest: wishlistItem.fromPrompt,
        style: selectedStyle,
        weather: weather || undefined,
        preferences: {
          preferredColors: userPreferences.preferredColors,
          preferredStyles: userPreferences.preferredStyles,
          dislikedItems: [],
          dislikedColors: []
        },
        useEnhancedPrompts: false
      });

      setGeneratedOutfit(outfitSuggestion);
      setOutfitPreviewImage(outfitSuggestion.previewImage);

      console.log('‚úÖ [WISHLIST] Successfully generated similar outfit');
    } catch (error) {
      console.error('‚ùå [WISHLIST] Failed to generate similar outfit:', error);
      alert('Failed to generate similar outfit. Please try again.');
    } finally {
      setIsGeneratingCustomOutfit(false);
    }
  };

  // Delete wishlist item
  const handleDeleteWishlistItem = (wishlistItem: WishlistItem) => {
    console.log('üóëÔ∏è [WISHLIST] Deleting item:', wishlistItem);

    const updatedWishlist = wishlistItems.filter(item => item.id !== wishlistItem.id);
    setWishlistItems(updatedWishlist);
    localStorage.setItem('fitChecked_wishlist', JSON.stringify(updatedWishlist));

    console.log('‚úÖ [WISHLIST] Successfully deleted item');
  };

  // Handle opening save modal with generated image
  const handleOpenSaveModal = (imageUrl: string, prompt: string) => {
    console.log('üîÑ [SAVE-MODAL] Opening save modal for generated item');
    setPendingSaveImage(imageUrl);
    setPendingSavePrompt(prompt);
    setShowSaveToClosetModal(true);
  };

  // Handle generation from multiple prompts in textarea
  const handleGenerateFromPrompts = async () => {
    if (!outfitPrompt.trim() || !weather) {
      console.error('‚ùå [PROMPT-GEN] Missing required inputs:', {
        prompt: !!outfitPrompt.trim(),
        weather: !!weather
      });
      alert('Please ensure prompts are entered and weather data is loaded');
      return;
    }

    console.log('üé® [PROMPT-GEN] Generating from multiple prompts...');

    // Using direct prompts that bypass weather/time constraints
    const season = 'spring';

    console.log('üïê [PROMPT-GEN] Using direct prompts (bypassing weather/time constraints):', { season });

    setIsGeneratingMultiple(true);
    setShowImageSelection(false);
    setMultipleOutfitImages(null);

    try {
      // Parse multiple prompts from textarea
      const parsedPrompts = await outfitGenerationService.parseMultiplePrompts(outfitPrompt);

      if (parsedPrompts.length === 0) {
        throw new Error('No valid prompts found');
      }

      console.log(`üîç [PROMPT-GEN] Found ${parsedPrompts.length} prompts to process`);

      // Generate outfit for the first prompt
      const customOutfit = await outfitGenerationService.generateCustomOutfit({
        prompt: parsedPrompts[0],
        style: selectedStyle,
        weather,
        timeOfDay: '', // Not used for direct prompts
        season,
        avatarImageUrl: avatarData?.imageUrl || avatarData,
        useDirectPrompt: true // Bypass weather constraints for custom prompts
      });

      if (customOutfit) {
        setGeneratedOutfit(customOutfit);

        // Generate images for all prompts
        const multipleImages = await outfitGenerationService.generateImagesFromMultiplePrompts(
          parsedPrompts,
          selectedStyle,
          weather,
          '', // timeOfDay not used for direct prompts
          season
        );

        if (multipleImages && multipleImages.length > 0) {
          setMultipleOutfitImages(multipleImages);
          setShowImageSelection(true);
          console.log(`‚úÖ [PROMPT-GEN] Generated ${multipleImages.length} images from prompts`);

          // Trigger save modal for the first generated image
          if (multipleImages[0]?.url) {
            handleOpenSaveModal(multipleImages[0].url, multipleImages[0].prompt);
          }
        } else {
          setOutfitPreviewImage(customOutfit.previewImage);
          console.log('‚úÖ [PROMPT-GEN] Generated single outfit from first prompt');

          // Trigger save modal for the generated image
          if (customOutfit.previewImage) {
            handleOpenSaveModal(customOutfit.previewImage, parsedPrompts[0]);
          }
        }
      }
    } catch (error) {
      console.error('‚ùå [PROMPT-GEN] Generation failed:', error);
      alert(`Failed to generate from prompts: ${error instanceof Error ? error.message : 'Unknown error'}`);
    } finally {
      setIsGeneratingMultiple(false);
    }
  };

  // Handle multiple image generation with variations
  const handleGenerateMultipleOutfits = async () => {
    if (!outfitPrompt.trim() || !weather) {
      console.error('‚ùå [MULTI-OUTFIT] Missing required inputs:', {
        prompt: !!outfitPrompt.trim(),
        weather: !!weather
      });
      alert('Please enter an outfit description and ensure weather data is loaded');
      return;
    }

    console.log('üé® [MULTI-OUTFIT] Starting multiple outfit generation...');

    // Use static values since we're using direct prompts that bypass weather/time constraints
    const season = 'spring';

    console.log('üïê [MULTI-OUTFIT] Using direct prompts (bypassing weather/time constraints):', { season });

    setIsGeneratingMultiple(true);
    setShowImageSelection(false);
    setMultipleOutfitImages(null);

    try {

      // Generate the outfit first
      const customOutfit = await outfitGenerationService.generateCustomOutfit({
        prompt: outfitPrompt,
        style: selectedStyle,
        weather,
        timeOfDay: '', // Not used for direct prompts
        season,
        avatarImageUrl: avatarData?.imageUrl || avatarData,
        useDirectPrompt: true // Bypass weather constraints for custom prompts
      });

      if (customOutfit) {
        setGeneratedOutfit(customOutfit);

        // Generate multiple variations
        const multiResult = await outfitGenerationService.generateMultipleGarmentImages(customOutfit, true);

        if (multiResult.success && multiResult.images.length > 0) {
          console.log('‚úÖ [MULTI-OUTFIT] Generated multiple images:', multiResult.images.length);
          setMultipleOutfitImages(multiResult.images);
          setShowImageSelection(true);
        } else {
          console.error('‚ùå [MULTI-OUTFIT] Failed to generate multiple images:', multiResult.error);
          // Fall back to single image generation
          await handleGenerateCustomOutfit();
        }
      }
    } catch (error) {
      console.error('‚ùå [MULTI-OUTFIT] Multiple generation failed:', error);
      // Fall back to single image generation
      await handleGenerateCustomOutfit();
    } finally {
      setIsGeneratingMultiple(false);
    }
  };

  // Handle user selection of preferred image
  const handleImageSelection = (selectedImage: { url: string; prompt: string; variation: string }) => {
    console.log('üëÜ [SELECTION] User selected:', selectedImage.variation);

    // Record the selection for learning
    outfitGenerationService.recordUserSelection(selectedImage.variation, selectedImage.prompt, generatedOutfit);

    // Use the selected image as the preview
    setOutfitPreviewImage(selectedImage.url);
    setShowImageSelection(false);
    setShowOutfitPreview(true);
  };

  // Auto-categorization function
  const detectGarmentCategory = (description: string): string => {
    const lowerDesc = description.toLowerCase();

    if (lowerDesc.includes('dress') || lowerDesc.includes('gown') || lowerDesc.includes('jumpsuit') || lowerDesc.includes('romper')) {
      return 'dresses';
    } else if (lowerDesc.includes('shirt') || lowerDesc.includes('blouse') || lowerDesc.includes('top') || lowerDesc.includes('sweater') || lowerDesc.includes('hoodie') || lowerDesc.includes('jacket') || lowerDesc.includes('coat')) {
      return 'shirts';
    } else if (lowerDesc.includes('pants') || lowerDesc.includes('jeans') || lowerDesc.includes('shorts') || lowerDesc.includes('trousers') || lowerDesc.includes('leggings')) {
      return 'pants';
    } else if (lowerDesc.includes('skirt')) {
      return 'skirts';
    } else if (lowerDesc.includes('shoe') || lowerDesc.includes('boot') || lowerDesc.includes('sneaker') || lowerDesc.includes('heel') || lowerDesc.includes('sandal')) {
      return 'shoes';
    } else if (lowerDesc.includes('bag') || lowerDesc.includes('purse') || lowerDesc.includes('backpack')) {
      return 'bags';
    } else {
      return 'accessories';
    }
  };

  const handleGenerateCustomOutfit = async () => {
    console.log('üöÄ [SEAMLESS-TRYON] Starting seamless virtual try-on workflow...');

    if (!outfitPrompt.trim()) {
      alert('Please enter a clothing description');
      return;
    }

    // Check if we have an avatar for virtual try-on
    const avatarImageUrl = avatarData?.imageUrl || avatarData;
    if (!avatarImageUrl) {
      alert('Please upload an avatar image first for virtual try-on');
      return;
    }

    console.log('üìù [SEAMLESS-TRYON] Starting workflow with:', {
      clothingDescription: outfitPrompt,
      style: selectedStyle,
      hasAvatar: !!avatarImageUrl
    });

    // Reset previous states
    setSeamlessTryOnResult(null);
    setTryOnProgress(null);
    setOutfitPreviewImage(null);
    setIsSeamlessTryOn(true);

    try {
      // Start the seamless two-step workflow
      const result = await seamlessTryOnService.generateAndTryOn(
        {
          clothingDescription: outfitPrompt,
          avatarImage: avatarImageUrl,
          style: selectedStyle,
          quality: 'balanced',
          enhancePrompts: true
        },
        (progress: TryOnProgress) => {
          console.log(`üìä [SEAMLESS-TRYON] Progress: ${progress.step} - ${progress.message} (${progress.progress}%)`);
          setTryOnProgress(progress);

          // Update UI based on progress
          if (progress.step === 'generating-clothing' && progress.clothingImageUrl) {
            // Show clothing preview in the right box during generation
            setOutfitPreviewImage(progress.clothingImageUrl);
          }
        }
      );

      console.log('‚úÖ [SEAMLESS-TRYON] Workflow completed:', result);
      setSeamlessTryOnResult(result);

      if (result.success) {
        if (result.finalImageUrl) {
          // Step 2 succeeded: Show avatar wearing the clothing
          console.log('üéâ [SEAMLESS-TRYON] Virtual try-on successful - showing avatar wearing clothing');
          setOutfitPreviewImage(result.finalImageUrl);

          // Auto-trigger save modal with the final result
          if (result.finalImageUrl) {
            handleOpenSaveModal(result.finalImageUrl, outfitPrompt);
          }
        } else if (result.clothingImageUrl) {
          // Step 1 succeeded, Step 2 failed: Show clothing only
          console.log('‚ö†Ô∏è [SEAMLESS-TRYON] Virtual try-on failed, showing clothing only');
          setOutfitPreviewImage(result.clothingImageUrl);

          // Auto-trigger save modal with the clothing result
          handleOpenSaveModal(result.clothingImageUrl, outfitPrompt);
        }

        // Show metrics to user
        if (result.step1Time && result.step2Time) {
          console.log(`‚è±Ô∏è [SEAMLESS-TRYON] Timing: Step 1: ${result.step1Time}s, Step 2: ${result.step2Time}s, Total: ${result.totalTime}s`);
        }

        // Clear progress when done
        setTryOnProgress({
          step: 'completed',
          message: result.finalImageUrl ? 'Virtual try-on completed!' : 'Clothing generated successfully!',
          progress: 100,
          clothingImageUrl: result.clothingImageUrl,
          finalImageUrl: result.finalImageUrl
        });

      } else {
        // Complete failure
        console.error('‚ùå [SEAMLESS-TRYON] Workflow failed:', result.error);
        alert(result.error || 'Failed to generate clothing. Please try again.');
      }

    } catch (error) {
      console.error('‚ùå [SEAMLESS-TRYON] Critical error:', error);

      // Provide user-friendly error messages
      let userMessage = 'Error during virtual try-on workflow. Please try again.';
      if (error.message?.includes('network') || error.message?.includes('fetch')) {
        userMessage = 'Network error. Please check your connection and try again.';
      } else if (error.message?.includes('avatar')) {
        userMessage = 'Avatar image error. Please try uploading a different avatar image.';
      }

      alert(userMessage);
      setTryOnProgress({
        step: 'error',
        message: error.message || 'Unknown error occurred',
        progress: 0
      });

    } finally {
      console.log('üèÅ [SEAMLESS-TRYON] Workflow complete, cleaning up...');
      setIsSeamlessTryOn(false);

      // Clear progress after a short delay to show final message
      setTimeout(() => {
        setTryOnProgress(null);
      }, 3000);
    }
  };

  // Apply generated outfit to avatar
  const handleApplyOutfitToAvatar = async () => {
    if (!generatedOutfit || !avatarData?.imageUrl) {
      alert('No outfit to apply or avatar image missing');
      return;
    }

    console.log('üëî Starting outfit application to avatar...');
    console.log('üìã Outfit details:', {
      name: generatedOutfit.name,
      style: generatedOutfit.style,
      pieces: generatedOutfit.pieces,
      hasPreviewImage: !!outfitPreviewImage
    });

    setIsApplyingOutfitToAvatar(true);
    setAvatarAnimation('changing');

    try {
      // Use the already generated outfit image if available, otherwise generate it
      let appliedOutfitUrl = outfitPreviewImage;

      if (!appliedOutfitUrl) {
        console.log('üé® No preview image available, generating outfit image...');
        appliedOutfitUrl = await outfitGenerationService.applyOutfitToAvatar(
          avatarData.imageUrl,
          generatedOutfit
        );
      } else {
        console.log('‚úÖ Using existing outfit preview image for application');
      }

      console.log('‚ú® Outfit application result:', {
        success: !!appliedOutfitUrl,
        imageType: appliedOutfitUrl?.startsWith('data:') ? 'base64' : 'url',
        imageLength: appliedOutfitUrl?.length || 0
      });

      setAvatarAnimation('posing');

      // Update the avatar data with the new outfit image
      if (onAvatarUpdate && appliedOutfitUrl) {
        onAvatarUpdate({
          imageUrl: appliedOutfitUrl,
          withOutfit: true,
          outfitDetails: `Custom ${generatedOutfit.style} outfit: ${generatedOutfit.name}`,
          customGenerated: true,
          developmentMode: true // Flag for development mode feedback
        });
        console.log('üì§ Updated parent component with new avatar outfit');
      }

      // Hide preview and reset states
      setShowOutfitPreview(false);
      setGeneratedOutfit(null);
      setOutfitPreviewImage(null);

      // Show enhanced success feedback
      setTimeout(() => {
        const message = import.meta.env.DEV
          ? `Successfully applied: "${generatedOutfit.name}"!\n\nüí° Development Mode: Outfit image used as avatar. In production, this would blend with your avatar.`
          : `Successfully applied: "${generatedOutfit.name}"!`;
        alert(message);
      }, 500);

    } catch (error) {
      console.error('Error applying outfit to avatar:', error);
      const errorMessage = import.meta.env.DEV
        ? 'Error applying outfit to avatar. Please try again.\n\nüí° Development Mode: Check console for detailed logs.'
        : 'Error applying outfit to avatar. Please try again.';
      alert(errorMessage);
      setAvatarAnimation('breathing');
    } finally {
      setIsApplyingOutfitToAvatar(false);
    }
  };

  // Generate another style with the same prompt
  const handleTryAnotherStyle = async () => {
    if (!outfitPrompt.trim() || !weather) return;

    // Clear current preview
    setGeneratedOutfit(null);
    setOutfitPreviewImage(null);

    // Regenerate with same prompt but potentially different style variations
    setIsGeneratingCustomOutfit(true);

    try {
      // Use static values since we're using direct prompts that bypass weather/time constraints
        const season = 'spring';

      // Generate new variation
      const customOutfit = await outfitGenerationService.generateCustomOutfit({
        prompt: outfitPrompt,
        style: selectedStyle,
        weather,
        timeOfDay: '', // Not used for direct prompts
        season,
        avatarImageUrl: avatarData?.imageUrl || avatarData,
        useDirectPrompt: true // Bypass weather constraints for custom prompts
      });

      if (customOutfit) {
        setGeneratedOutfit(customOutfit);

        // Generate garment-only image for preview (no person wearing clothes)
        try {
          const garmentOnlyImageUrl = await outfitGenerationService.generateGarmentOnlyImage(customOutfit);
          setOutfitPreviewImage(garmentOnlyImageUrl);
        } catch (error) {
          console.warn('Could not generate new garment preview image:', error);
        }

        console.log('üîÑ Generated new outfit variation:', customOutfit.name);
      }

    } catch (error) {
      console.error('Error generating new outfit variation:', error);
      alert('Error generating new variation. Please try again.');
    } finally {
      setIsGeneratingCustomOutfit(false);
    }
  };

  // Rate generated outfit
  const handleRateOutfit = (rating: number) => {
    if (!generatedOutfit) return;

    console.log(`‚≠ê User rated outfit "${generatedOutfit.name}" with ${rating} stars`);

    // Store rating in localStorage for learning user preferences
    const outfitRatings = JSON.parse(localStorage.getItem('outfitRatings') || '{}');
    const outfitKey = `${generatedOutfit.name}_${generatedOutfit.style}`;
    outfitRatings[outfitKey] = {
      rating,
      outfit: generatedOutfit,
      timestamp: Date.now()
    };
    localStorage.setItem('outfitRatings', JSON.stringify(outfitRatings));

    // Update user preferences based on rating
    if (rating >= 4) {
      const newPreferences = {
        ...userPreferences,
        preferredStyles: [...new Set([...userPreferences.preferredStyles, generatedOutfit.style])],
        preferredColors: [...new Set([...userPreferences.preferredColors, ...generatedOutfit.colors])]
      };
      saveUserPreferences(newPreferences);
    }

    // Show feedback
    alert(`Thanks for rating! Your feedback helps us learn your style preferences.`);
  };

  // Save outfit to favorites
  const handleSaveOutfitToFavorites = () => {
    if (!generatedOutfit) return;

    const favoriteOutfits = JSON.parse(localStorage.getItem('favoriteOutfits') || '[]');

    // Check if already saved
    const alreadySaved = favoriteOutfits.some((fav: any) =>
      fav.name === generatedOutfit.name && fav.style === generatedOutfit.style
    );

    if (alreadySaved) {
      alert('This outfit is already in your favorites!');
      return;
    }

    // Add to favorites
    const favoriteOutfit = {
      ...generatedOutfit,
      savedAt: Date.now(),
      previewImage: outfitPreviewImage
    };

    favoriteOutfits.push(favoriteOutfit);
    localStorage.setItem('favoriteOutfits', JSON.stringify(favoriteOutfits));

    console.log('üíù Saved outfit to favorites:', favoriteOutfit.name);
    alert(`"${generatedOutfit.name}" has been saved to your favorites!`);
  };

  const getGreetingEmoji = () => {
    const personalizedGreeting = UserService.getPersonalizedGreeting(userData);
    return personalizedGreeting.emoji || null;
  };

  const isSpecialGreeting = () => {
    const personalizedGreeting = UserService.getPersonalizedGreeting(userData);
    return personalizedGreeting.isSpecial;
  };

  const getWeatherIcon = () => {
    if (!weather) return <Sun className="w-6 h-6 text-yellow-500" />;

    switch (weather.condition) {
      case 'sunny': return <Sun className="w-6 h-6 text-yellow-500" />;
      case 'cloudy': return <Cloud className="w-6 h-6 text-slate-500" />;
      case 'rainy': return <CloudRain className="w-6 h-6 text-blue-500" />;
      case 'snowy': return <Snowflake className="w-6 h-6 text-blue-300" />;
      default: return <Sun className="w-6 h-6 text-yellow-500" />;
    }
  };

  const getWeatherGradient = () => {
    if (!weather) return 'from-blue-400 to-blue-600';

    switch (weather.condition) {
      case 'sunny': return 'from-yellow-400 to-orange-500';
      case 'cloudy': return 'from-slate-400 to-slate-600';
      case 'rainy': return 'from-blue-400 to-blue-600';
      case 'snowy': return 'from-blue-300 to-blue-500';
      default: return 'from-blue-400 to-blue-600';
    }
  };

  const generateOutfitSuggestions = async () => {
    if (!weather) return;

    setIsGeneratingOutfits(true);

    try {
      const now = new Date();
      const month = now.getMonth() + 1;
      const hour = now.getHours();

      // Determine time of day
      let timeOfDay: 'morning' | 'afternoon' | 'evening' | 'night' = 'afternoon';
      if (hour >= 5 && hour < 12) timeOfDay = 'morning';
      else if (hour >= 12 && hour < 17) timeOfDay = 'afternoon';
      else if (hour >= 17 && hour < 21) timeOfDay = 'evening';
      else timeOfDay = 'night';

      // Determine season
      let season: 'spring' | 'summer' | 'fall' | 'winter' = 'spring';
      if (month >= 3 && month <= 5) season = 'spring';
      else if (month >= 6 && month <= 8) season = 'summer';
      else if (month >= 9 && month <= 11) season = 'fall';
      else season = 'winter';

      // Check if user has items in their closet
      const userClosetStats = ClosetService.getClosetStats();
      const hasClothingItems = userClosetStats.totalItems > 0;

      const suggestions = await outfitGenerationService.generateOutfitSuggestions({
        weather,
        styleProfile: styleProfile || {},
        avatarImageUrl: avatarData?.imageUrl || avatarData,
        numberOfSuggestions: 3,
        timeOfDay: '', // Not used for direct prompts
        season,
        month,
        usePersonalWardrobe: hasClothingItems
      });

      setOutfitSuggestions(suggestions);
    } catch (error) {
      console.error('Failed to generate outfit suggestions:', error);
      // Fallback to simple suggestions
      setOutfitSuggestions([
        {
          id: 1,
          name: 'Weather-Perfect Look',
          description: `Ideal for ${weather.temperature}¬∞F ${weather.condition} weather`,
          weatherAppropriate: true,
          styleMatch: 95,
          pieces: weather.temperature > 70 ? ['Light Top', 'Comfortable Bottoms', 'Casual Shoes'] : ['Warm Layer', 'Jeans', 'Boots'],
          colors: ['Navy', 'White', 'Camel'],
          style: 'Smart Casual',
          occasion: 'Daily wear',
          temperature_range: { min: weather.temperature - 10, max: weather.temperature + 10 }
        },
        {
          id: 2,
          name: 'Trendy Choice',
          description: 'On-trend pieces for a stylish day',
          weatherAppropriate: true,
          styleMatch: 87,
          pieces: ['Designer Top', 'Tailored Pants', 'Statement Accessories'],
          colors: ['Black', 'Gold', 'Cream'],
          style: 'Contemporary',
          occasion: 'Social',
          temperature_range: { min: weather.temperature - 5, max: weather.temperature + 5 }
        }
      ]);
    } finally {
      setIsGeneratingOutfits(false);
    }
  };

  const applyOutfitToAvatar = async (outfitId: number) => {
    const outfit = outfitSuggestions.find(o => o.id === outfitId);
    if (!outfit) return;

    setApplyingOutfit(true);
    setSelectedOutfit(outfitId);

    // Apply outfit transition animation
    if (avatarRef.current) {
      const transition = avatarAnimationService.createOutfitTransition();

      // Pre-transition glow
      avatarRef.current.className = `${avatarRef.current.className} ${transition.preTransition}`;

      setTimeout(() => {
        // Main transition
        if (avatarRef.current) {
          avatarRef.current.className = avatarRef.current.className.replace(transition.preTransition, transition.transition);
        }
      }, 500);

      setTimeout(() => {
        // Post-transition bounce
        if (avatarRef.current) {
          avatarRef.current.className = avatarRef.current.className.replace(transition.transition, transition.postTransition);
        }
      }, 1500);

      setTimeout(() => {
        // Return to breathing animation
        if (avatarRef.current) {
          avatarAnimationService.clearAnimations(avatarRef.current);
          avatarAnimationService.applyAnimation(avatarRef.current, 'breathing', 'subtle');
        }
        setApplyingOutfit(false);
      }, 2500);
    }

    // Try to apply outfit using fal.ai if avatar image is available
    if (avatarData?.imageUrl || avatarData) {
      try {
        const newAvatarImage = await outfitGenerationService.applyOutfitToAvatar(
          avatarData?.imageUrl || avatarData,
          outfit
        );
        // Note: In a real implementation, you'd update the avatar image here
        console.log('New avatar with outfit:', newAvatarImage);
      } catch (error) {
        console.error('Failed to apply outfit to avatar:', error);
      }
    }
  };

  const formatTime = (date: Date) => {
    return date.toLocaleTimeString([], {
      hour: '2-digit',
      minute: '2-digit'
    });
  };

  const formatDate = (date: Date) => {
    return date.toLocaleDateString('en-US', {
      weekday: 'long',
      month: 'short',
      day: 'numeric'
    });
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 via-white to-blue-50">
      {/* Animation Keyframes */}
      <style>{`
        ${avatarAnimationService.getAnimationKeyframes()}

        @keyframes float {
          0%, 100% { transform: translateY(0px); }
          50% { transform: translateY(-8px); }
        }

        @keyframes glow {
          0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
          50% { box-shadow: 0 0 30px rgba(59, 130, 246, 0.5); }
        }

        @keyframes shimmer {
          0% { background-position: -200% 0; }
          100% { background-position: 200% 0; }
        }

        @keyframes pixelFloat {
          0%, 100% { transform: translateY(0px) translateX(0px); opacity: 0.3; }
          50% { transform: translateY(-15px) translateX(10px); opacity: 0.8; }
        }

        @keyframes pixelDrift {
          0% { transform: translateX(-20px); opacity: 0; }
          50% { opacity: 0.6; }
          100% { transform: translateX(200px); opacity: 0; }
        }

        @keyframes pixelPulse {
          0%, 100% { opacity: 0.2; transform: scale(1); }
          50% { opacity: 0.7; transform: scale(1.2); }
        }

        @keyframes pixelDiagonal {
          0% { transform: translateX(-15px) translateY(15px); opacity: 0; }
          50% { opacity: 0.5; }
          100% { transform: translateX(150px) translateY(-15px); opacity: 0; }
        }

        .float-animation {
          animation: float 6s ease-in-out infinite;
        }

        .glow-animation {
          animation: glow 3s ease-in-out infinite;
        }


        @keyframes origamiUnfold {
          /* Phase 1: Shirt (0-20%) */
          0%, 20% {
            clip-path: polygon(25% 20%, 75% 20%, 80% 25%, 85% 30%, 85% 35%, 82% 40%, 78% 45%, 75% 50%, 70% 55%, 65% 60%, 60% 65%, 55% 70%, 50% 75%, 45% 70%, 40% 65%, 35% 60%, 30% 55%, 25% 50%, 22% 45%, 18% 40%, 15% 35%, 15% 30%, 20% 25%);
            transform: rotateY(0deg) scale(1);
            filter: hue-rotate(0deg);
          }

          /* Transition to Pants */
          21% {
            clip-path: polygon(20% 25%, 80% 25%, 82% 30%, 85% 35%, 87% 40%, 85% 45%, 82% 50%, 78% 55%, 75% 60%, 70% 65%, 65% 70%, 60% 75%, 55% 80%, 45% 80%, 40% 75%, 35% 70%, 30% 65%, 25% 60%, 22% 55%, 18% 50%, 15% 45%, 13% 40%, 15% 35%, 18% 30%);
            transform: rotateY(5deg) scale(1.02);
            filter: hue-rotate(20deg);
          }

          /* Phase 2: Pants (22-40%) */
          22%, 40% {
            clip-path: polygon(30% 25%, 70% 25%, 72% 30%, 75% 35%, 77% 40%, 75% 45%, 73% 50%, 70% 55%, 68% 60%, 65% 75%, 63% 85%, 62% 95%, 60% 100%, 40% 100%, 38% 95%, 37% 85%, 35% 75%, 32% 60%, 30% 55%, 27% 50%, 25% 45%, 23% 40%, 25% 35%, 28% 30%);
            transform: rotateY(0deg) scale(1);
            filter: hue-rotate(60deg);
          }

          /* Transition to Shoes */
          41% {
            clip-path: polygon(25% 30%, 75% 30%, 78% 35%, 82% 40%, 85% 45%, 87% 50%, 85% 55%, 80% 60%, 75% 65%, 70% 70%, 65% 75%, 55% 80%, 45% 85%, 35% 88%, 25% 85%, 20% 80%, 18% 75%, 15% 70%, 13% 65%, 12% 60%, 15% 55%, 18% 50%, 22% 45%, 25% 40%);
            transform: rotateY(-5deg) scale(1.02);
            filter: hue-rotate(120deg);
          }

          /* Phase 3: Shoes (42-60%) */
          42%, 60% {
            clip-path: polygon(15% 60%, 85% 60%, 90% 65%, 92% 70%, 90% 75%, 87% 80%, 82% 85%, 75% 90%, 65% 92%, 55% 93%, 45% 93%, 35% 92%, 25% 90%, 18% 85%, 13% 80%, 10% 75%, 8% 70%, 10% 65%);
            transform: rotateY(0deg) scale(1);
            filter: hue-rotate(180deg);
          }

          /* Transition to Tie */
          61% {
            clip-path: polygon(40% 15%, 60% 15%, 65% 20%, 68% 25%, 70% 30%, 68% 35%, 65% 40%, 62% 45%, 60% 50%, 58% 55%, 55% 60%, 52% 65%, 50% 70%, 48% 65%, 45% 60%, 42% 55%, 40% 50%, 38% 45%, 35% 40%, 32% 35%, 30% 30%, 32% 25%, 35% 20%);
            transform: rotateY(3deg) scale(1.01);
            filter: hue-rotate(240deg);
          }

          /* Phase 4: Tie (62-80%) */
          62%, 80% {
            clip-path: polygon(42% 10%, 58% 10%, 62% 15%, 65% 20%, 67% 25%, 65% 30%, 62% 35%, 60% 40%, 58% 45%, 56% 50%, 54% 55%, 52% 60%, 50% 85%, 48% 60%, 46% 55%, 44% 50%, 42% 45%, 40% 40%, 38% 35%, 35% 30%, 33% 25%, 35% 20%, 38% 15%);
            transform: rotateY(0deg) scale(1);
            filter: hue-rotate(300deg);
          }

          /* Transition to Hat */
          81% {
            clip-path: polygon(20% 35%, 80% 35%, 85% 40%, 88% 45%, 90% 50%, 88% 55%, 85% 60%, 80% 65%, 70% 70%, 65% 72%, 60% 74%, 55% 75%, 45% 75%, 40% 74%, 35% 72%, 30% 70%, 20% 65%, 15% 60%, 12% 55%, 10% 50%, 12% 45%, 15% 40%);
            transform: rotateY(-3deg) scale(1.01);
            filter: hue-rotate(360deg);
          }

          /* Phase 5: Hat (82-100%) */
          82%, 100% {
            clip-path: polygon(25% 40%, 75% 40%, 80% 45%, 85% 50%, 87% 55%, 85% 60%, 80% 65%, 75% 70%, 70% 72%, 65% 74%, 60% 75%, 55% 76%, 45% 76%, 40% 75%, 35% 74%, 30% 72%, 25% 70%, 20% 65%, 15% 60%, 13% 55%, 15% 50%, 20% 45%);
            transform: rotateY(0deg) scale(1);
            filter: hue-rotate(0deg);
          }
        }

        @keyframes origamiFoldLines {
          0%, 20% {
            background-position: 0% 30%, 100% 70%, 30% 0%, 70% 100%;
            opacity: 0.3;
          }
          21%, 40% {
            background-position: 20% 50%, 80% 50%, 50% 20%, 50% 80%;
            opacity: 0.4;
          }
          41%, 60% {
            background-position: 10% 80%, 90% 20%, 80% 10%, 20% 90%;
            opacity: 0.5;
          }
          61%, 80% {
            background-position: 50% 10%, 50% 90%, 10% 50%, 90% 50%;
            opacity: 0.3;
          }
          81%, 100% {
            background-position: 25% 40%, 75% 60%, 40% 25%, 60% 75%;
            opacity: 0.2;
          }
        }

        @keyframes origamiPaperTexture {
          0%, 100% {
            background-color: rgba(255, 255, 255, 0.1);
            box-shadow:
              0 8px 25px rgba(59, 130, 246, 0.3),
              0 3px 12px rgba(139, 69, 19, 0.1),
              inset 0 1px 3px rgba(255, 255, 255, 0.4),
              inset 0 -1px 3px rgba(0, 0, 0, 0.1);
          }
          25% {
            background-color: rgba(255, 248, 220, 0.15);
            box-shadow:
              0 10px 30px rgba(34, 197, 94, 0.3),
              0 4px 15px rgba(139, 69, 19, 0.15),
              inset 0 1px 4px rgba(255, 255, 255, 0.5),
              inset 0 -1px 4px rgba(0, 0, 0, 0.15);
          }
          50% {
            background-color: rgba(245, 245, 220, 0.2);
            box-shadow:
              0 12px 35px rgba(168, 85, 247, 0.3),
              0 5px 18px rgba(139, 69, 19, 0.2),
              inset 0 2px 5px rgba(255, 255, 255, 0.6),
              inset 0 -2px 5px rgba(0, 0, 0, 0.2);
          }
          75% {
            background-color: rgba(255, 239, 213, 0.15);
            box-shadow:
              0 10px 30px rgba(239, 68, 68, 0.3),
              0 4px 15px rgba(139, 69, 19, 0.15),
              inset 0 1px 4px rgba(255, 255, 255, 0.5),
              inset 0 -1px 4px rgba(0, 0, 0, 0.15);
          }
        }

        .organic-button {
          position: relative;
          background: linear-gradient(135deg,
            #3b82f6 0%,
            #2563eb 30%,
            #1d4ed8 70%,
            #1e40af 100%);
          clip-path: polygon(25% 20%, 75% 20%, 80% 25%, 85% 30%, 85% 35%, 82% 40%, 78% 45%, 75% 50%, 70% 55%, 65% 60%, 60% 65%, 55% 70%, 50% 75%, 45% 70%, 40% 65%, 35% 60%, 30% 55%, 25% 50%, 22% 45%, 18% 40%, 15% 35%, 15% 30%, 20% 25%);
          animation: origamiUnfold 20s ease-in-out infinite, origamiPaperTexture 20s ease-in-out infinite;
          border: none;
          transition: all 0.3s ease;
          overflow: visible;
          will-change: clip-path, filter, transform;
        }

        .organic-button::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background:
            linear-gradient(45deg, transparent 48%, rgba(139, 69, 19, 0.3) 49%, rgba(139, 69, 19, 0.3) 51%, transparent 52%),
            linear-gradient(-45deg, transparent 48%, rgba(139, 69, 19, 0.2) 49%, rgba(139, 69, 19, 0.2) 51%, transparent 52%),
            linear-gradient(90deg, transparent 48%, rgba(210, 180, 140, 0.4) 49%, rgba(210, 180, 140, 0.4) 51%, transparent 52%),
            linear-gradient(0deg, transparent 48%, rgba(210, 180, 140, 0.3) 49%, rgba(210, 180, 140, 0.3) 51%, transparent 52%);
          background-size: 40px 40px, 40px 40px, 60px 60px, 60px 60px;
          animation: origamiFoldLines 20s ease-in-out infinite;
          pointer-events: none;
          z-index: 1;
        }

        .organic-button::after {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(255, 255, 255, 0.1);
          backdrop-filter: blur(1px);
          pointer-events: none;
          z-index: 2;
        }

        .organic-button:hover {
          background: linear-gradient(135deg,
            #2563eb 0%,
            #1d4ed8 30%,
            #1e40af 70%,
            #1e3a8a 100%);
          transform: scale(1.05);
          animation-duration: 12s, 12s;
          animation-play-state: paused;
        }

        .organic-button:hover::before {
          animation-play-state: paused;
          opacity: 0.8;
        }

        .organic-button:active {
          transform: scale(0.98);
          animation-play-state: running;
          animation-duration: 2s, 2s;
        }

        .organic-button:active::before {
          animation-duration: 2s;
        }

        .origami-icon-container {
          position: relative;
          overflow: hidden;
        }

        .origami-icon-container::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background:
            linear-gradient(45deg, transparent 48%, rgba(255, 255, 255, 0.1) 49%, rgba(255, 255, 255, 0.1) 51%, transparent 52%),
            linear-gradient(-45deg, transparent 48%, rgba(255, 255, 255, 0.05) 49%, rgba(255, 255, 255, 0.05) 51%, transparent 52%);
          background-size: 20px 20px, 20px 20px;
          animation: origamiIconFold 8s ease-in-out infinite;
          pointer-events: none;
          z-index: 1;
        }

        .origami-icon-container .lucide {
          position: relative;
          z-index: 2;
          animation: origamiIconTransform 8s ease-in-out infinite;
        }

        @keyframes origamiIconFold {
          0%, 20% {
            background-position: 0% 0%, 100% 100%;
            opacity: 0.3;
          }
          21%, 40% {
            background-position: 20% 20%, 80% 80%;
            opacity: 0.4;
          }
          41%, 60% {
            background-position: 40% 40%, 60% 60%;
            opacity: 0.5;
          }
          61%, 80% {
            background-position: 60% 60%, 40% 40%;
            opacity: 0.3;
          }
          81%, 100% {
            background-position: 80% 80%, 20% 20%;
            opacity: 0.2;
          }
        }

        @keyframes origamiIconTransform {
          0%, 20% {
            transform: rotate(0deg) scale(1);
          }
          21%, 40% {
            transform: rotate(5deg) scale(1.05);
          }
          41%, 60% {
            transform: rotate(-3deg) scale(0.95);
          }
          61%, 80% {
            transform: rotate(2deg) scale(1.02);
          }
          81%, 100% {
            transform: rotate(0deg) scale(1);
          }
        }

        .shimmer-text {
          background: linear-gradient(90deg, transparent, rgba(255,255,255,0.8), transparent);
          background-size: 200% 100%;
          animation: shimmer 2s infinite;
        }

        .pixel {
          position: absolute;
          width: 6px;
          height: 6px;
          border-radius: 2px;
          pointer-events: none;
          z-index: 50;
          box-shadow: 0 0 4px rgba(0,0,0,0.2);
        }

        .pixel-1 {
          background-color: #0ea5e9;
          animation: pixelFloat 4s ease-in-out infinite;
          animation-delay: 0s;
        }

        .pixel-2 {
          background-color: #06b6d4;
          animation: pixelDrift 6s linear infinite;
          animation-delay: 1s;
        }

        .pixel-3 {
          background-color: #10b981;
          animation: pixelPulse 3s ease-in-out infinite;
          animation-delay: 0.5s;
        }

        .pixel-4 {
          background-color: #8b5cf6;
          animation: pixelDiagonal 5s linear infinite;
          animation-delay: 2s;
        }

        .pixel-5 {
          background-color: #0ea5e9;
          animation: pixelFloat 4.5s ease-in-out infinite;
          animation-delay: 1.5s;
        }

        .pixel-6 {
          background-color: #f59e0b;
          animation: pixelDrift 7s linear infinite;
          animation-delay: 0.2s;
        }

        .pixel-7 {
          background-color: #8b5cf6;
          animation: pixelPulse 3.5s ease-in-out infinite;
          animation-delay: 2.5s;
        }

        .pixel-8 {
          background-color: #10b981;
          animation: pixelDiagonal 5.5s linear infinite;
          animation-delay: 0.8s;
        }

        @keyframes organicFlow {
          0%, 100% {
            clip-path: path("M0,0 C120,30 280,10 400,40 C520,70 680,20 800,50 L800,0 Z");
          }
          50% {
            clip-path: path("M0,0 C140,20 260,50 420,25 C540,5 660,45 800,35 L800,0 Z");
          }
        }

        @keyframes organicFlow2 {
          0%, 100% {
            clip-path: path("M0,20 C100,5 200,45 350,15 C500,35 650,10 800,30 L800,0 L0,0 Z");
          }
          50% {
            clip-path: path("M0,35 C150,15 250,50 380,20 C520,40 680,5 800,25 L800,0 L0,0 Z");
          }
        }

        @keyframes organicPulse {
          0%, 100% {
            transform: scale(1) translateY(0px);
            opacity: 0.8;
          }
          50% {
            transform: scale(1.02) translateY(-2px);
            opacity: 0.9;
          }
        }

        @keyframes organicBottomFlow {
          0%, 100% {
            clip-path: path("M0,0 C120,15 280,5 400,20 C520,35 680,10 800,25 L800,40 L0,40 Z");
          }
          50% {
            clip-path: path("M0,0 C140,10 260,25 420,12 C540,2 660,22 800,17 L800,40 L0,40 Z");
          }
        }

        @keyframes softPulse {
          0%, 100% {
            transform: scale(0.98);
            opacity: 0.85;
          }
          50% {
            transform: scale(1.02);
            opacity: 1;
          }
        }

        .organic-header {
          position: relative;
          overflow: hidden;
          margin-bottom: 2rem;
          padding-bottom: 1rem;
        }

        .main-content-section {
          border-top: 1px solid rgba(0, 0, 0, 0.1);
          padding-top: 1rem;
        }

        .organic-shape-1 {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 120%;
          background: linear-gradient(135deg,
            rgba(251, 191, 36, 0.3) 0%,
            rgba(168, 85, 247, 0.2) 30%,
            rgba(59, 130, 246, 0.25) 60%,
            rgba(16, 185, 129, 0.2) 100%);
          clip-path: path("M0,0 C120,30 280,10 400,40 C520,70 680,20 800,50 L800,0 Z");
          animation: organicFlow 8s ease-in-out infinite;
          z-index: 1;
        }

        .organic-shape-2 {
          position: absolute;
          top: -10px;
          left: 0;
          width: 100%;
          height: 110%;
          background: linear-gradient(45deg,
            rgba(239, 68, 68, 0.15) 0%,
            rgba(245, 158, 11, 0.2) 40%,
            rgba(139, 92, 246, 0.18) 80%,
            rgba(6, 182, 212, 0.15) 100%);
          clip-path: path("M0,20 C100,5 200,45 350,15 C500,35 650,10 800,30 L800,0 L0,0 Z");
          animation: organicFlow2 12s ease-in-out infinite reverse;
          z-index: 2;
        }

        .organic-shape-3 {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(255, 255, 255, 0.4);
          backdrop-filter: blur(20px);
          animation: organicPulse 6s ease-in-out infinite;
          z-index: 3;
        }

        .organic-content {
          position: relative;
          z-index: 10;
        }

        .organic-bottom-border {
          position: absolute;
          bottom: 0;
          left: 0;
          width: 100%;
          height: 40px;
          background: linear-gradient(135deg,
            rgba(59, 130, 246, 0.3) 0%,
            rgba(168, 85, 247, 0.25) 30%,
            rgba(16, 185, 129, 0.3) 60%,
            rgba(251, 191, 36, 0.2) 100%);
          clip-path: path("M0,0 C120,15 280,5 400,20 C520,35 680,10 800,25 L800,40 L0,40 Z");
          animation: organicBottomFlow 10s ease-in-out infinite;
          z-index: 5;
        }

        .tab-base {
          transition: all 0.3s ease-in-out;
          transform-origin: center;
        }

        .tab-pulse {
          animation: softPulse 3.5s ease-in-out infinite;
        }

        .tab-interactive:hover {
          transform: scale(1.05);
          opacity: 1;
        }

        .tab-interactive:active {
          transform: scale(0.95);
          transition: all 0.1s ease-in-out;
        }

        @keyframes sparkleFloat {
          0%, 100% {
            transform: translateY(0px) translateX(0px);
          }
          33% {
            transform: translateY(-8px) translateX(4px);
          }
          66% {
            transform: translateY(4px) translateX(-6px);
          }
        }

        @keyframes sparkleTwinkle {
          0%, 100% {
            opacity: 0.3;
          }
          50% {
            opacity: 1;
          }
        }

        @keyframes sparkleRotate {
          0% {
            transform: rotate(0deg);
          }
          100% {
            transform: rotate(360deg);
          }
        }

        .sparkle-container {
          position: relative;
        }

        .sparkle {
          position: absolute;
          color: rgba(255, 193, 7, 0.8);
          pointer-events: none;
          z-index: 1;
        }

        .sparkle-1 {
          top: -8px;
          left: -8px;
          animation: sparkleFloat 3s ease-in-out infinite, sparkleTwinkle 2s ease-in-out infinite;
          animation-delay: 0s, 0.5s;
        }

        .sparkle-2 {
          top: -12px;
          right: -8px;
          animation: sparkleFloat 3.5s ease-in-out infinite, sparkleTwinkle 2.5s ease-in-out infinite;
          animation-delay: 0.7s, 1s;
        }

        .sparkle-3 {
          bottom: -8px;
          left: -12px;
          animation: sparkleFloat 2.8s ease-in-out infinite, sparkleTwinkle 2.2s ease-in-out infinite;
          animation-delay: 1.2s, 0.3s;
        }

        .sparkle-4 {
          bottom: -12px;
          right: -8px;
          animation: sparkleFloat 3.2s ease-in-out infinite, sparkleTwinkle 2.8s ease-in-out infinite;
          animation-delay: 0.4s, 1.5s;
        }

        .sparkle-5 {
          top: 50%;
          left: -15px;
          animation: sparkleFloat 2.5s ease-in-out infinite, sparkleTwinkle 2s ease-in-out infinite;
          animation-delay: 1.8s, 0.8s;
        }

        .sparkle-6 {
          top: 50%;
          right: -15px;
          animation: sparkleFloat 3.8s ease-in-out infinite, sparkleTwinkle 2.3s ease-in-out infinite;
          animation-delay: 0.2s, 1.2s;
        }

        .avatar-styling {
          position: relative;
          border: 2px solid transparent;
          background:
            linear-gradient(135deg,
              rgba(255, 255, 255, 0.8) 0%,
              rgba(255, 255, 255, 0.4) 30%,
              rgba(0, 0, 0, 0.05) 70%,
              rgba(0, 0, 0, 0.1) 100%),
            linear-gradient(to bottom right, #f0f8ff, #e6f3ff);
          background-clip: padding-box;
          box-shadow:
            0 0 20px rgba(59, 130, 246, 0.3),
            0 8px 16px rgba(0, 0, 0, 0.15),
            0 16px 32px rgba(0, 0, 0, 0.1),
            inset 0 1px 3px rgba(255, 255, 255, 0.4),
            inset 0 -1px 3px rgba(0, 0, 0, 0.1);
        }

        .avatar-styling::before {
          content: '';
          position: absolute;
          top: -3px;
          left: -3px;
          right: -3px;
          bottom: -3px;
          background: linear-gradient(135deg,
            rgba(255, 255, 255, 0.6) 0%,
            rgba(255, 255, 255, 0.2) 50%,
            rgba(0, 0, 0, 0.1) 100%);
          border-radius: inherit;
          z-index: -1;
        }

      `}</style>

      {/* Header */}
      <header className="relative z-10 organic-header min-h-[120px]">
        {/* Organic Background Shapes */}
        <div className="organic-shape-1"></div>
        <div className="organic-shape-2"></div>
        <div className="organic-shape-3"></div>
        <div className="organic-bottom-border"></div>

        <div className="max-w-7xl mx-auto px-6 py-8 organic-content">
          <div className="flex items-center justify-start">
            {/* Back Button */}
            <button
              onClick={onBack}
            >
              <ArrowLeft className="w-6 h-6 text-black" />
            </button>

            {/* Title & Greeting */}
            <div className="text-left ml-6">
              <div className="relative inline-block py-4 px-2" style={{minWidth: '350px', minHeight: '60px'}}>
                <h1 className="text-3xl font-bold text-black mb-1 relative z-20">
                  Your Digital Self
                </h1>
                {/* Moving Pixels */}
                <div className="pixel pixel-1" style={{top: '-5px', left: '10px'}}></div>
                <div className="pixel pixel-2" style={{top: '15px', left: '40px'}}></div>
                <div className="pixel pixel-3" style={{top: '5px', left: '110px'}}></div>
                <div className="pixel pixel-4" style={{top: '35px', left: '160px'}}></div>
                <div className="pixel pixel-5" style={{top: '8px', left: '210px'}}></div>
                <div className="pixel pixel-6" style={{top: '25px', left: '70px'}}></div>
                <div className="pixel pixel-7" style={{top: '-2px', left: '180px'}}></div>
                <div className="pixel pixel-8" style={{top: '30px', left: '120px'}}></div>
              </div>
              <p className={`flex items-center space-x-2 ${isSpecialGreeting() ? 'text-amber-600 font-medium' : 'text-slate-600'}`}>
                <span className="flex items-center space-x-2">
                  <span>{getGreeting()}!</span>
                  {getGreetingEmoji() && (
                    <span className="text-lg">{getGreetingEmoji()}</span>
                  )}
                </span>
                <span className="w-1 h-1 bg-slate-400 rounded-full"></span>
                <span>{formatDate(currentTime)}</span>
              </p>
            </div>

            {/* Time & Weather */}
            <div className="flex items-center space-x-4 ml-auto">
              {/* Current Time */}
              <div className="text-right">
                <div className="text-2xl font-mono font-bold text-slate-800">
                  {formatTime(currentTime)}
                </div>
                <div className="text-sm text-slate-500">
                  Local time
                </div>
              </div>

              {/* Weather Widget */}
              <div className={`relative bg-gradient-to-br ${getWeatherGradient()} text-white p-4 rounded-3xl shadow-lg min-w-[180px]`}>
                {weatherLoading ? (
                  <div className="flex items-center space-x-3">
                    <Loader className="w-6 h-6 animate-spin" />
                    <div>
                      <div className="text-lg font-semibold">Loading...</div>
                      <div className="text-sm opacity-80">Weather data</div>
                    </div>
                  </div>
                ) : weatherError ? (
                  <div className="flex items-center space-x-3">
                    <AlertCircle className="w-6 h-6" />
                    <div>
                      <div className="text-lg font-semibold">Offline</div>
                      <div className="text-sm opacity-80">Using cached data</div>
                    </div>
                  </div>
                ) : weather ? (
                  <>
                    <div className="flex items-center space-x-3 mb-2">
                      {getWeatherIcon()}
                      <div>
                        <div className="text-2xl font-bold">
                          {weather.temperature}¬∞F
                        </div>
                        <div className="text-sm opacity-90 capitalize">
                          {weather.condition}
                        </div>
                      </div>
                    </div>
                    <div className="flex items-center space-x-1 text-sm opacity-80">
                      <MapPin className="w-3 h-3" />
                      <span className="truncate">{weather.location}</span>
                    </div>
                  </>
                ) : null}
              </div>
            </div>
          </div>
        </div>
      </header>

      {/* Main Content */}
      <main className="relative z-10 max-w-7xl mx-auto px-6 py-8 main-content-section">
        {/* NEW LAYOUT: Avatar center-left, prompt center-top, sliding preview right */}
        <div className="relative flex h-screen max-h-[800px]">

          {/* Left Side: Always-visible Avatar (60% width) */}
          <div className="w-[60%] flex items-center justify-center p-8">
            <div className="relative">
              <div
                ref={avatarRef}
                className={`relative float-animation ${avatarAnimationService.getAnimationClass(avatarAnimation, 'subtle')}`}
              >
                <div className="w-80 aspect-[9/16] rounded-3xl flex items-center justify-center overflow-hidden relative avatar-styling shadow-2xl">
                  {avatarData ? (
                    <img
                      src={avatarData.imageUrl || avatarData}
                      alt="Your Digital Avatar"
                      className="w-full h-full object-cover"
                    />
                  ) : (
                    <div className="flex flex-col items-center space-y-6">
                      <div className="w-24 h-24 bg-gradient-to-br from-blue-400 to-indigo-500 rounded-full flex items-center justify-center">
                        <User className="w-12 h-12 text-white" />
                      </div>
                      <div className="text-center">
                        <h3 className="text-xl font-semibold text-slate-700 mb-2">Your Avatar</h3>
                        <p className="text-slate-500">Upload an avatar to get started</p>
                      </div>
                    </div>
                  )}

                  {/* Loading overlays */}
                  {(applyingOutfit || isApplyingOutfitToAvatar) && (
                    <div className="absolute inset-0 bg-black/20 flex items-center justify-center">
                      <div className="bg-white/90 rounded-2xl px-6 py-3 flex items-center space-x-3 shadow-lg">
                        <Loader className="w-5 h-5 animate-spin text-blue-600" />
                        <span className="font-medium">Applying outfit...</span>
                      </div>
                    </div>
                  )}

                  {/* Weather indicator */}
                  {weather && (
                    <div className="absolute bottom-4 left-4 bg-white/80 backdrop-blur-sm text-slate-700 px-3 py-2 rounded-full text-sm font-medium flex items-center space-x-2 shadow-sm">
                      {getWeatherIcon()}
                      <span>
                        {weather.temperature > 75 ? 'Summer Ready' :
                         weather.temperature > 60 ? 'Perfect Weather' :
                         'Cozy & Warm'}
                      </span>
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>

          {/* Center: Prompt Input Bar at Top */}
          <div className="absolute top-8 left-1/2 transform -translate-x-1/2 z-20 w-96">
            <div className="bg-white/90 backdrop-blur-sm rounded-2xl shadow-lg p-6 border border-gray-200">
              <div className="space-y-4">
                <div>
                  <label className="text-sm font-medium text-gray-700 mb-2 block">
                    Describe your outfit
                  </label>
                  <textarea
                    value={outfitPrompt}
                    onChange={(e) => setOutfitPrompt(e.target.value)}
                    placeholder="e.g., 'red casual t-shirt', 'elegant black dress', 'denim jacket'"
                    className="w-full p-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none h-20"
                    disabled={isGeneratingCustomOutfit}
                  />
                </div>

                <div className="flex items-center space-x-3">
                  <select
                    value={selectedStyle}
                    onChange={(e) => setSelectedStyle(e.target.value as any)}
                    className="px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm"
                    disabled={isGeneratingCustomOutfit}
                  >
                    <option value="casual">Casual</option>
                    <option value="formal">Formal</option>
                    <option value="trendy">Trendy</option>
                    <option value="vintage">Vintage</option>
                    <option value="minimalist">Minimalist</option>
                    <option value="edgy">Edgy</option>
                  </select>

                  <button
                    onClick={handleGenerateCustomOutfit}
                    disabled={isGeneratingCustomOutfit || !outfitPrompt.trim()}
                    className="flex-1 bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-4 py-2 rounded-xl font-medium hover:from-purple-700 hover:to-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2"
                  >
                    {isGeneratingCustomOutfit ? (
                      <>
                        <Loader className="w-4 h-4 animate-spin" />
                        <span>Generating...</span>
                      </>
                    ) : (
                      <>
                        <Sparkles className="w-4 h-4" />
                        <span>Generate</span>
                      </>
                    )}
                  </button>
                </div>
              </div>
            </div>
          </div>

          {/* Right Side: Sliding Preview Box (25% width, slides in from right) */}
          <div className={`absolute right-0 top-0 h-full w-[25%] transition-transform duration-300 ease-in-out ${
            showOutfitPreviewSlideIn ? 'translate-x-0' : 'translate-x-full'
          }`}>
            <div className="h-full p-6 flex flex-col">
              {/* Preview Box */}
              <div className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl border border-gray-200 p-4 flex-1 flex flex-col">
                <h3 className="text-lg font-semibold text-gray-800 mb-4">Outfit Preview</h3>

                {/* Preview Image */}
                <div className="flex-1 bg-gradient-to-br from-purple-50 to-indigo-50 rounded-xl overflow-hidden mb-4">
                  {outfitPreviewImage ? (
                    <img
                      src={outfitPreviewImage}
                      alt="Generated Outfit"
                      className="w-full h-full object-cover"
                    />
                  ) : (
                    <div className="w-full h-full flex items-center justify-center text-gray-400">
                      <Shirt className="w-16 h-16" />
                    </div>
                  )}
                </div>

                {/* Action Buttons */}
                <div className="space-y-2">
                  <button
                    onClick={handleWearIt}
                    disabled={!previewOutfit || isApplyingOutfitToAvatar}
                    className="w-full bg-green-600 text-white py-3 rounded-xl font-medium hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2"
                  >
                    {isApplyingOutfitToAvatar ? (
                      <>
                        <Loader className="w-4 h-4 animate-spin" />
                        <span>Applying...</span>
                      </>
                    ) : (
                      <>
                        <ArrowRightCircle className="w-4 h-4" />
                        <span>Wear It</span>
                      </>
                    )}
                  </button>

                  <div className="flex space-x-2">
                    <button
                      onClick={handleRetryGeneration}
                      disabled={isGeneratingCustomOutfit}
                      className="flex-1 bg-blue-600 text-white py-2 rounded-lg font-medium hover:bg-blue-700 disabled:opacity-50 flex items-center justify-center space-x-1"
                    >
                      <RefreshCw className="w-4 h-4" />
                      <span>Retry</span>
                    </button>

                    <button
                      onClick={handleDiscardPreview}
                      className="flex-1 bg-gray-600 text-white py-2 rounded-lg font-medium hover:bg-gray-700 flex items-center justify-center space-x-1"
                    >
                      <Trash2 className="w-4 h-4" />
                      <span>Discard</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* Wishlist Tab (subtle, right edge) */}
          <div className={`absolute right-0 top-1/2 transform -translate-y-1/2 transition-all duration-300 ${
            showWishlistTab ? 'translate-x-0' : 'translate-x-full'
          }`}>
            <div className="bg-purple-600 text-white rounded-l-lg px-4 py-6 shadow-lg cursor-pointer hover:bg-purple-700"
                 onClick={handleAddToWishlist}>
              <div className="writing-vertical text-sm font-medium">
                Add to Wishlist?
              </div>
            </div>
          </div>

          <style jsx>{`
            .writing-vertical {
              writing-mode: vertical-rl;
              text-orientation: mixed;
            }
          `}</style>

                  {/* Avatar Display */}
                  <div className="flex-shrink-0">
                    <div className="relative inline-block">
                      <div
                        ref={avatarRef}
                        className={`relative float-animation ${avatarAnimationService.getAnimationClass(avatarAnimation, 'subtle')}`}
                      >
                        <div className="w-72 aspect-[9/16] rounded-3xl flex items-center justify-center overflow-hidden relative avatar-styling">
                          {avatarData ? (
                            <img
                              src={avatarData.imageUrl || avatarData}
                              alt="Your Digital Avatar"
                              className="w-full h-full object-cover"
                            />
                          ) : (
                            <div className="flex flex-col items-center space-y-6">
                              <div className="w-24 h-24 bg-gradient-to-br from-blue-400 to-indigo-500 rounded-full flex items-center justify-center">
                                <User className="w-12 h-12 text-white" />
                              </div>
                              <div className="text-center">
                                <h3 className="text-xl font-semibold text-slate-700 mb-2">Your Avatar</h3>
                                <p className="text-slate-500">Personalized digital representation</p>
                              </div>
                            </div>
                          )}

                          {/* Loading Overlay */}
                          {applyingOutfit && (
                            <div className="absolute inset-0 glass-beige-dark flex items-center justify-center">
                              <div className="glass-beige-light text-slate-800 px-6 py-3 rounded-2xl flex items-center space-x-3 shadow-lg">
                                <Loader className="w-5 h-5 animate-spin text-blue-600" />
                                <span className="font-medium">Styling your look...</span>
                              </div>
                            </div>
                          )}

                          {/* Success Indicator */}
                          {selectedOutfit && !applyingOutfit && (
                            <div className="absolute top-4 right-4 bg-green-500 text-white px-3 py-1 rounded-full text-sm font-medium flex items-center space-x-1 shadow-lg">
                              <Sparkles className="w-4 h-4" />
                              <span>Styled!</span>
                            </div>
                          )}

                          {/* Weather Indicator */}
                          {weather && (
                            <div className="absolute bottom-4 left-4 glass-beige-light text-slate-700 px-3 py-2 rounded-full text-sm font-medium flex items-center space-x-2 shadow-sm">
                              {getWeatherIcon()}
                              <span>
                                {weather.temperature > 75 ? 'Summer Ready' :
                                 weather.temperature > 60 ? 'Perfect Weather' :
                                 'Cozy & Warm'}
                              </span>
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Outfit Preview Display */}
                  {showOutfitPreview && (
                    <div className="flex-shrink-0">
                      <div className="relative inline-block">
                        <div
                          ref={outfitPreviewRef}
                          className="relative float-animation"
                        >
                          <div className="w-72 aspect-[9/16] rounded-3xl flex items-center justify-center overflow-hidden relative avatar-styling bg-gradient-to-br from-purple-50 via-indigo-50 to-blue-50 border-2 border-purple-200">

                            {/* Outfit Preview Content */}
                            {(() => {
                              const renderState = {
                                isGeneratingCustomOutfit,
                                hasOutfitPreviewImage: !!outfitPreviewImage,
                                outfitPreviewImageLength: outfitPreviewImage?.length || 0,
                                outfitPreviewImageType: outfitPreviewImage?.startsWith('data:image/svg') ? 'svg-base64' :
                                                       outfitPreviewImage?.startsWith('data:') ? 'base64' :
                                                       outfitPreviewImage?.startsWith('http') ? 'url' : 'none',
                                hasGeneratedOutfit: !!generatedOutfit,
                                outfitName: generatedOutfit?.name,
                                willShowImage: !isGeneratingCustomOutfit && !!outfitPreviewImage,
                                willShowText: !isGeneratingCustomOutfit && !outfitPreviewImage && !!generatedOutfit,
                                willShowLoader: isGeneratingCustomOutfit,
                                actualOutfitPreviewImageValue: outfitPreviewImage
                              };
                              console.log('üé≠ [PREVIEW-STATE] DETAILED render state:', renderState);

                              if (renderState.willShowText) {
                                console.error('‚ùå [PREVIEW-STATE] FALLING BACK TO TEXT!');
                                console.error('‚ùå [PREVIEW-STATE] Reasons:', {
                                  isGenerating: isGeneratingCustomOutfit,
                                  hasImage: !!outfitPreviewImage,
                                  hasOutfit: !!generatedOutfit,
                                  imageValue: outfitPreviewImage
                                });
                              }
                              if (renderState.willShowImage) {
                                console.log('‚úÖ [PREVIEW-STATE] WILL RENDER IMAGE!');
                                console.log('‚úÖ [PREVIEW-STATE] Image data:', outfitPreviewImage?.substring(0, 100) + '...');
                              }
                              if (renderState.willShowLoader) {
                                console.log('‚è≥ [PREVIEW-STATE] WILL SHOW LOADER');
                              }

                              return null;
                            })()}
                            {/* SIMPLIFIED LOGIC: Image takes absolute priority */}
                            {outfitPreviewImage ? (
                              <div className="w-full h-full relative">
                                <img
                                  src={outfitPreviewImage}
                                  alt="Generated Outfit Preview"
                                  className="w-full h-full object-cover"
                                  onLoad={() => {
                                    console.log('‚úÖ [IMAGE] Successfully loaded outfit preview image');
                                  }}
                                  onError={(e) => {
                                    console.error('‚ùå [IMAGE] Failed to load outfit preview image:', e);
                                    console.error('‚ùå [IMAGE] Failed image src:', outfitPreviewImage?.substring(0, 100) + '...');
                                  }}
                                />
                                {isGeneratingCustomOutfit && (
                                  <div className="absolute inset-0 bg-black/20 flex items-center justify-center">
                                    <div className="bg-white/90 rounded-lg p-4 text-center">
                                      <Loader className="w-8 h-8 text-purple-600 animate-spin mx-auto mb-2" />
                                      <p className="text-sm text-slate-700">Updating...</p>
                                    </div>
                                  </div>
                                )}
                              </div>
                            ) : isGeneratingCustomOutfit ? (
                              <div className="flex flex-col items-center space-y-6 p-6">
                                <div className="w-24 h-24 bg-gradient-to-br from-purple-400 to-indigo-500 rounded-full flex items-center justify-center">
                                  <Loader className="w-12 h-12 text-white animate-spin" />
                                </div>
                                <div className="text-center">
                                  <h3 className="text-xl font-semibold text-slate-700 mb-2">Generating Outfit</h3>
                                  <p className="text-slate-500">Creating your perfect look...</p>
                                </div>
                              </div>
                            ) : generatedOutfit ? (
                              <div className="flex flex-col items-center space-y-4 p-6 text-center">
                                <div className="w-24 h-24 bg-gradient-to-br from-purple-400 to-indigo-500 rounded-full flex items-center justify-center">
                                  <Sparkles className="w-12 h-12 text-white" />
                                </div>
                                <div>
                                  <h3 className="text-lg font-bold text-slate-800 mb-2">{generatedOutfit.name}</h3>
                                  <p className="text-sm text-slate-600 mb-4">{generatedOutfit.description}</p>

                                  {/* Outfit Details */}
                                  {generatedOutfit.pieces && (
                                    <div className="space-y-2">
                                      <p className="text-xs font-semibold text-purple-700">Outfit Pieces:</p>
                                      <div className="flex flex-wrap gap-1 justify-center">
                                        {generatedOutfit.pieces.slice(0, 3).map((piece: string, index: number) => (
                                          <span key={index} className="bg-purple-100 text-purple-700 px-2 py-1 rounded-full text-xs">
                                            {piece}
                                          </span>
                                        ))}
                                      </div>
                                    </div>
                                  )}

                                  {/* Colors */}
                                  {generatedOutfit.colors && (
                                    <div className="mt-3">
                                      <p className="text-xs font-semibold text-purple-700 mb-1">Colors:</p>
                                      <div className="flex flex-wrap gap-1 justify-center">
                                        {generatedOutfit.colors.map((color: string, index: number) => (
                                          <span key={index} className="bg-slate-100 text-slate-600 px-2 py-1 rounded-full text-xs">
                                            {color}
                                          </span>
                                        ))}
                                      </div>
                                    </div>
                                  )}
                                </div>
                              </div>
                            ) : null}

                            {/* Apply to Avatar Button - Only show when outfit is ready */}
                            {generatedOutfit && !isGeneratingCustomOutfit && !isApplyingOutfitToAvatar && (
                              <div className="absolute bottom-4 left-4 right-4">
                                <button
                                  onClick={handleApplyOutfitToAvatar}
                                  className="w-full bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white py-3 px-4 rounded-xl font-semibold transition-all duration-300 hover:scale-105 shadow-lg flex items-center justify-center space-x-2"
                                  title={import.meta.env.DEV ? "Development Mode: Will use outfit image as avatar" : "Apply this outfit to your avatar"}
                                >
                                  <Sparkles className="w-4 h-4" />
                                  <span>Apply to Avatar</span>
                                  {import.meta.env.DEV && (
                                    <span className="ml-1 text-xs opacity-75">üîß</span>
                                  )}
                                </button>
                              </div>
                            )}

                            {/* Applying Animation Overlay */}
                            {isApplyingOutfitToAvatar && (
                              <div className="absolute inset-0 glass-beige-dark flex items-center justify-center">
                                <div className="glass-beige-light text-slate-800 px-6 py-3 rounded-2xl flex items-center space-x-3 shadow-lg">
                                  <Loader className="w-5 h-5 animate-spin text-purple-600" />
                                  <span className="font-medium">Applying to avatar...</span>
                                </div>
                              </div>
                            )}

                            {/* Preview Label */}
                            <div className="absolute top-4 left-4 bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-sm font-medium flex items-center space-x-1 shadow-sm">
                              <Eye className="w-3 h-3" />
                              <span>Preview</span>
                            </div>

                            {/* Top Action Buttons */}
                            {generatedOutfit && !isGeneratingCustomOutfit && !isApplyingOutfitToAvatar && (
                              <div className="absolute top-4 right-4 flex space-x-2">
                                <button
                                  onClick={handleTryAnotherStyle}
                                  className="bg-white/80 hover:bg-white text-purple-600 p-2 rounded-full transition-all duration-300 hover:scale-105 shadow-md"
                                  title="Try Another Style"
                                >
                                  <RefreshCw className="w-4 h-4" />
                                </button>
                                <button
                                  onClick={() => {
                                    setShowOutfitPreview(false);
                                    setGeneratedOutfit(null);
                                    setOutfitPreviewImage(null);
                                  }}
                                  className="bg-white/80 hover:bg-white text-slate-600 p-2 rounded-full transition-all duration-300 hover:scale-105 shadow-md"
                                  title="Close Preview"
                                >
                                  <span className="w-4 h-4 flex items-center justify-center text-sm font-bold">√ó</span>
                                </button>
                              </div>
                            )}

                          </div>
                        </div>
                      </div>
                    </div>
                  )}

                </div>
              </div>
            </div>

            {/* Today's Picks Section - Below Avatar */}
            <div className="mt-8">
              <div className="glass-beige rounded-3xl shadow-xl overflow-hidden">
                <div className="p-6 border-b border-slate-100">
                  <div className="flex items-center justify-between">
                    <div>
                      <h3 className="text-xl font-bold text-slate-800 flex items-center space-x-2">
                        <TrendingUp className="w-5 h-5 text-blue-600" />
                        <span>Today's Picks</span>
                      </h3>
                      <p className="text-sm text-slate-600 mt-1">Create and customize your style</p>
                    </div>

                    {/* Upload and Closet Buttons */}
                    <div className="flex items-center space-x-3">
                      <button
                        onClick={handleSmartUpload}
                        disabled={uploadingClothing}
                        className="flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-sm font-medium transition-all duration-300 hover:scale-105 disabled:opacity-50 shadow-lg"
                      >
                        {uploadingClothing ? (
                          <>
                            <Loader className="w-4 h-4 animate-spin" />
                            <span>Processing...</span>
                          </>
                        ) : (
                          <>
                            <Camera className="w-4 h-4" />
                            <span>Upload Outfit</span>
                          </>
                        )}
                      </button>

                      {/* Closet and Wishlist Tab Buttons */}
                      <div className="flex space-x-2">
                        <button
                          onClick={() => {
                            if (onNavigateToCloset) {
                              onNavigateToCloset();
                            } else {
                              console.log('Navigate to closet - door transition not available');
                            }
                          }}
                          className="flex items-center space-x-2 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-xl text-sm font-medium transition-all duration-300 hover:scale-105 shadow-lg"
                        >
                          <span>üëó</span>
                          <span>My Closet</span>
                        </button>

                        <button
                          onClick={() => setActiveView('wishlist')}
                          className="flex items-center space-x-2 bg-pink-600 hover:bg-pink-700 text-white px-4 py-2 rounded-xl text-sm font-medium transition-all duration-300 hover:scale-105 shadow-lg relative"
                        >
                          <ShoppingCart className="w-4 h-4" />
                          <span>Wishlist</span>
                          {wishlistItems.length > 0 && (
                            <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold">
                              {wishlistItems.length}
                            </span>
                          )}
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <div className="p-6">
                  {/* Custom Outfit Generator */}
                  <div className="p-6 bg-gradient-to-r from-purple-50 via-blue-50 to-indigo-50 rounded-2xl border border-purple-200 shadow-lg">
                    <div className="text-center mb-6">
                      <h4 className="text-xl font-bold text-slate-800 flex items-center justify-center space-x-2 mb-2">
                        <Sparkles className="w-6 h-6 text-purple-600" />
                        <span>Create Your Custom Outfit</span>
                        <Sparkles className="w-6 h-6 text-purple-600" />
                      </h4>
                      <p className="text-sm text-slate-600">Describe your ideal outfit and watch it come to life on your avatar</p>
                    </div>

                    {/* Style Selection Buttons */}
                    <div className="flex flex-wrap justify-center gap-2 mb-6">
                      {[
                        { key: 'casual', label: 'Casual', emoji: 'üéØ', color: 'blue' },
                        { key: 'formal', label: 'Formal', emoji: 'üëî', color: 'gray' },
                        { key: 'trendy', label: 'Trendy', emoji: '‚ú®', color: 'pink' },
                        { key: 'vintage', label: 'Vintage', emoji: 'üï∞Ô∏è', color: 'amber' },
                        { key: 'minimalist', label: 'Minimalist', emoji: '‚ö™', color: 'slate' },
                        { key: 'edgy', label: 'Edgy', emoji: 'üî•', color: 'red' }
                      ].map((style) => (
                        <button
                          key={style.key}
                          onClick={() => setSelectedStyle(style.key as any)}
                          className={`flex items-center space-x-2 px-4 py-2 rounded-xl text-sm font-medium transition-all duration-300 hover:scale-105 ${
                            selectedStyle === style.key
                              ? `bg-${style.color}-100 text-${style.color}-700 border-2 border-${style.color}-300 shadow-md`
                              : 'bg-white text-slate-600 border border-slate-200 hover:border-purple-300 hover:bg-purple-50'
                          }`}
                        >
                          <span className="text-lg">{style.emoji}</span>
                          <span>{style.label}</span>
                        </button>
                      ))}
                    </div>

                    {/* Outfit Description Input */}
                    <div className="mb-6">
                      <textarea
                        value={outfitPrompt}
                        onChange={(e) => setOutfitPrompt(e.target.value)}
                        placeholder="Describe your ideal outfit... (e.g., 'Cozy oversized sweater with dark jeans and ankle boots', 'Elegant black dress with statement jewelry', 'Casual white t-shirt with denim jacket and sneakers')"
                        rows={3}
                        className="w-full px-4 py-3 border-2 border-purple-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none text-slate-700 placeholder-slate-400"
                      />
                    </div>

                    {/* Generate Buttons */}
                    <div className="text-center space-y-3">
                      <button
                        onClick={handleGenerateCustomOutfit}
                        disabled={isSeamlessTryOn || isGeneratingMultiple || !outfitPrompt.trim()}
                        className="flex items-center space-x-2 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white px-8 py-3 rounded-xl text-lg font-semibold transition-all duration-300 hover:scale-105 disabled:opacity-50 disabled:hover:scale-100 shadow-lg mx-auto"
                      >
                        {isSeamlessTryOn ? (
                          <>
                            <Loader className="w-5 h-5 animate-spin" />
                            <span>{tryOnProgress?.message || 'Processing...'}</span>
                          </>
                        ) : (
                          <>
                            <Sparkles className="w-5 h-5" />
                            <span>Generate & Try On</span>
                          </>
                        )}
                      </button>

                      {/* Progress Bar */}
                      {tryOnProgress && (
                        <div className="max-w-md mx-auto">
                          <div className="bg-gray-200 rounded-full h-2 mb-2">
                            <div
                              className="bg-gradient-to-r from-purple-600 to-indigo-600 h-2 rounded-full transition-all duration-500"
                              style={{ width: `${tryOnProgress.progress}%` }}
                            ></div>
                          </div>
                          <p className="text-sm text-gray-600 text-center">
                            {tryOnProgress.step === 'generating-clothing' && 'üß• Creating your clothing...'}
                            {tryOnProgress.step === 'applying-to-avatar' && 'üë§ Applying to your avatar...'}
                            {tryOnProgress.step === 'completed' && '‚úÖ Complete!'}
                            {tryOnProgress.step === 'error' && '‚ùå Error occurred'}
                          </p>
                        </div>
                      )}

                      {/* Preview Prompts Buttons */}
                      <div className="flex flex-col space-y-2">
                        <button
                          onClick={handleWebEnhancedPrompts}
                          disabled={isGeneratingCustomOutfit || !outfitPrompt.trim()}
                          className="flex items-center space-x-2 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white px-6 py-2 rounded-lg text-sm font-medium transition-all duration-300 hover:scale-105 disabled:opacity-50 disabled:hover:scale-100 shadow-lg mx-auto"
                        >
                          <span>üåê</span>
                          <span>AI + Web Enhanced Prompts</span>
                        </button>

                      </div>

                      {/* Generate From Prompts Button - appears when textarea contains multiple prompts */}
                      {outfitPrompt.includes('---') && (
                        <button
                          onClick={handleGenerateFromPrompts}
                          disabled={isGeneratingMultiple || !outfitPrompt.trim()}
                          className="flex items-center space-x-2 bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-700 hover:to-orange-700 text-white px-6 py-2 rounded-lg text-sm font-medium transition-all duration-300 hover:scale-105 disabled:opacity-50 disabled:hover:scale-100 shadow-lg mx-auto"
                        >
                          {isGeneratingMultiple ? (
                            <>
                              <Loader className="w-4 h-4 animate-spin" />
                              <span>Generating...</span>
                            </>
                          ) : (
                            <>
                              <span>üé®</span>
                              <span>Generate From Prompts</span>
                            </>
                          )}
                        </button>
                      )}
                    </div>

                    {/* Pro Tip */}
                    <div className="mt-4 p-3 bg-purple-100 rounded-lg border border-purple-200">
                      <p className="text-xs text-purple-700 text-center">
                        üí° <strong>Pro Tip:</strong> Be specific about colors, styles, and pieces for best results. The AI will consider current weather and time of day!
                      </p>
                    </div>
                  </div>

                  {/* Navigation Tabs - Bottom of Today's Picks */}
                  <div className="mt-6 px-6 pb-6">
                    <div className="flex flex-col sm:flex-row gap-4 justify-center items-center">

                      {/* Update Measurements Tab */}
                      <div className="flex-1 max-w-sm">
                        <div className="sparkle-container">
                          <div
                            onClick={() => {
                              if (onNavigateToMeasurements) {
                                onNavigateToMeasurements();
                              } else {
                                console.log('Navigate to measurements');
                              }
                            }}
                            className="text-center cursor-pointer hover:text-gray-600 w-full tab-base tab-pulse tab-interactive bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-xl border border-blue-200 hover:border-blue-300 transition-all duration-300 hover:scale-105"
                          >
                            <div className="font-semibold text-gray-800 text-lg mb-1">Update Measurements</div>
                            <div className="text-sm text-gray-600">Perfect fit</div>
                          </div>
                          {/* Sparkles around Update Measurements */}
                          <Sparkles className="sparkle sparkle-1 w-3 h-3" />
                          <Sparkles className="sparkle sparkle-2 w-4 h-4" />
                          <Sparkles className="sparkle sparkle-3 w-3 h-3" />
                          <Sparkles className="sparkle sparkle-4 w-4 h-4" />
                          <Sparkles className="sparkle sparkle-5 w-3 h-3" />
                        </div>
                      </div>

                      {/* Edit Style Profile Tab */}
                      <div className="flex-1 max-w-sm">
                        <div className="sparkle-container">
                          <div
                            onClick={() => {
                              if (onNavigateToStyleProfile) {
                                onNavigateToStyleProfile();
                              } else {
                                console.log('Navigate to style profile');
                              }
                            }}
                            className="text-center cursor-pointer hover:text-gray-600 w-full tab-base tab-pulse tab-interactive bg-gradient-to-r from-purple-50 to-pink-50 p-4 rounded-xl border border-purple-200 hover:border-purple-300 transition-all duration-300 hover:scale-105"
                          >
                            <div className="font-semibold text-gray-800 text-lg mb-1">Edit Style Profile</div>
                            <div className="text-sm text-gray-600">Your preferences</div>
                          </div>
                          {/* Sparkles around Edit Style Profile */}
                          <Sparkles className="sparkle sparkle-1 w-3 h-3" />
                          <Sparkles className="sparkle sparkle-2 w-4 h-4" />
                          <Sparkles className="sparkle sparkle-3 w-3 h-3" />
                          <Sparkles className="sparkle sparkle-4 w-4 h-4" />
                        </div>
                      </div>

                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* Right Section: Weather Recommendations */}
          <div className="flex-1 lg:flex-[1]">
            <div className="space-y-6">

            {/* Weather Recommendations */}
            <div className={`glass-beige rounded-3xl shadow-xl overflow-hidden bg-gradient-to-br ${getWeatherGradient().replace('from-', 'from-').replace('to-', 'to-')}/10`}>
              <div className="p-6 border-b border-slate-100">
                <div className="flex items-center justify-between">
                  <div>
                    <h3 className="text-xl font-bold text-slate-800 flex items-center space-x-2">
                      {getWeatherIcon()}
                      <span>Weather Outfits</span>
                    </h3>
                    <p className="text-sm text-slate-600 mt-1">Perfect for {weather?.temperature}¬∞F {weather?.condition}</p>
                  </div>

                  <div className="flex items-center space-x-2">
                    <button
                      onClick={() => handleSmartRefresh('smart')}
                      disabled={isGeneratingOutfits}
                      className="flex items-center space-x-2 bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-xl transition-all duration-300 hover:scale-105 disabled:opacity-50 disabled:hover:scale-100"
                    >
                      <RefreshCw className={`w-4 h-4 ${isGeneratingOutfits ? 'animate-spin' : ''}`} />
                      <span className="text-sm font-medium">Refresh</span>
                    </button>
                    <button
                      onClick={() => setShowRefreshModal(true)}
                      disabled={isGeneratingOutfits}
                      className="flex items-center space-x-1 bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-2 rounded-xl transition-all duration-300 hover:scale-105 disabled:opacity-50"
                    >
                      <span className="text-sm font-medium">‚öôÔ∏è</span>
                    </button>
                  </div>
                </div>
              </div>

              <div className="p-6">

                {isGeneratingOutfits ? (
                  <div className="space-y-4">
                    {[1, 2].map(i => (
                      <div key={i} className="bg-gradient-to-r from-slate-50 to-blue-50 rounded-2xl p-4 animate-pulse">
                        <div className="h-4 bg-slate-200 rounded w-3/4 mb-3"></div>
                        <div className="h-3 bg-slate-200 rounded w-1/2 mb-2"></div>
                        <div className="flex space-x-2">
                          <div className="h-6 bg-slate-200 rounded-full w-16"></div>
                          <div className="h-6 bg-slate-200 rounded-full w-16"></div>
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="space-y-4">
                    {outfitSuggestions.map(outfit => (
                      <div
                        key={outfit.id}
                        className={`group relative p-5 rounded-2xl cursor-pointer transition-all duration-300 hover:scale-105 ${
                          selectedOutfit === outfit.id
                            ? 'bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 shadow-lg'
                            : 'bg-gradient-to-r from-slate-50 to-blue-50 border border-slate-200 hover:border-blue-200 hover:shadow-md'
                        }`}
                        onClick={() => applyOutfitToAvatar(outfit.id)}
                      >
                        <div className="flex items-start justify-between mb-3">
                          <div className="flex-1">
                            <div className="flex items-center space-x-2 mb-2">
                              <h4 className="font-bold text-slate-800 text-lg">
                                {outfit.name}
                              </h4>
                              {outfit.weatherAppropriate && (
                                <span className="inline-flex items-center space-x-1 bg-green-100 text-green-700 px-2 py-1 rounded-full text-xs font-medium">
                                  <span>Weather Perfect</span>
                                  <span>üå§Ô∏è</span>
                                </span>
                              )}
                            </div>


                            <p className="text-slate-600 mb-4 leading-relaxed">
                              {outfit.description}
                            </p>

                            {/* Style Tags */}
                            <div className="flex flex-wrap gap-2 mb-3">
                              {outfit.pieces.slice(0, 3).map((piece, index) => (
                                <span
                                  key={index}
                                  className="inline-flex items-center bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm font-medium"
                                >
                                  {piece}
                                </span>
                              ))}
                            </div>

                            {/* Colors */}
                            {outfit.colors && outfit.colors.length > 0 && (
                              <div className="flex items-center space-x-2 mb-3">
                                <span className="text-sm text-slate-500 font-medium">Colors:</span>
                                <div className="flex space-x-1">
                                  {outfit.colors.map((color, index) => (
                                    <span
                                      key={index}
                                      className="bg-slate-100 text-slate-600 px-2 py-1 rounded-full text-xs font-medium"
                                    >
                                      {color}
                                    </span>
                                  ))}
                                </div>
                              </div>
                            )}

                            {/* Match Score & Actions */}
                            <div className="flex items-center justify-between">
                              <div className="flex items-center space-x-2">
                                <Eye className="w-4 h-4 text-slate-400" />
                                <span className="text-sm text-slate-500">
                                  {outfit.styleMatch}% style match
                                </span>
                              </div>

                              <div className="flex items-center space-x-1 text-blue-600 group-hover:translate-x-1 transition-transform">
                                <span className="text-sm font-medium">Try it</span>
                                <Sparkles className="w-4 h-4" />
                              </div>
                            </div>

                            {/* Like/Skip Actions */}
                            <div className="flex items-center justify-between mt-3 pt-3 border-t border-slate-100">
                              <div className="flex items-center space-x-2">
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    handleOutfitLike(outfit.id);
                                  }}
                                  className="flex items-center space-x-1 text-green-600 hover:text-green-700 transition-colors"
                                >
                                  <span className="text-lg">üëç</span>
                                  <span className="text-xs font-medium">Like</span>
                                </button>

                                <button
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    handleOutfitSkip(outfit.id);
                                  }}
                                  className="flex items-center space-x-1 text-red-600 hover:text-red-700 transition-colors"
                                >
                                  <span className="text-lg">üëé</span>
                                  <span className="text-xs font-medium">Skip</span>
                                </button>
                              </div>

                              {userPreferences.likedOutfits.includes(outfit.id) && (
                                <span className="text-xs text-green-600 font-medium">‚ú® Liked</span>
                              )}
                            </div>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                )}

              </div>
            </div>
            </div>
          </div>
        </div>
      </main>

      {/* Upload Modal */}
      {showUploadModal && uploadPreview && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl max-w-lg w-full overflow-hidden shadow-2xl max-h-[90vh] overflow-y-auto">
            <div className="p-6">
              <h3 className="text-xl font-bold text-gray-800 mb-4">Add New Clothing Item</h3>

              {/* Image Preview */}
              <div className="aspect-square w-full mb-6 rounded-xl overflow-hidden bg-gray-100">
                <img
                  src={uploadPreview}
                  alt="Clothing preview"
                  className="w-full h-full object-cover"
                />
              </div>

              {/* Category Selection */}
              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 mb-2">Category</label>
                <select
                  value={selectedCategory}
                  onChange={(e) => setSelectedCategory(e.target.value as ClothingCategory)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                  <option value="shirts">Shirts</option>
                  <option value="tops">Tops</option>
                  <option value="pants">Pants</option>
                  <option value="dresses">Dresses</option>
                  <option value="skirts">Skirts</option>
                  <option value="outerwear">Outerwear</option>
                  <option value="shoes">Shoes</option>
                  <option value="accessories">Accessories</option>
                </select>
              </div>

              {/* Name Input */}
              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 mb-2">Name</label>
                <input
                  type="text"
                  value={clothingName}
                  onChange={(e) => setClothingName(e.target.value)}
                  placeholder="Enter clothing name"
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
              </div>

              {/* Description Input */}
              <div className="mb-6">
                <label className="block text-sm font-medium text-gray-700 mb-2">Description (Optional)</label>
                <textarea
                  value={clothingDescription}
                  onChange={(e) => setClothingDescription(e.target.value)}
                  placeholder="Add a description..."
                  rows={3}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
              </div>

              {/* Action Buttons */}
              <div className="flex space-x-3">
                <button
                  onClick={saveClothingToCloset}
                  disabled={uploadingClothing || !clothingName.trim()}
                  className="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-medium transition-colors disabled:opacity-50 flex items-center justify-center space-x-2"
                >
                  {uploadingClothing ? (
                    <>
                      <Loader className="w-4 h-4 animate-spin" />
                      <span>Saving...</span>
                    </>
                  ) : (
                    <>
                      <Sparkles className="w-4 h-4" />
                      <span>Save & Try On</span>
                    </>
                  )}
                </button>
                <button
                  onClick={() => {
                    setShowUploadModal(false);
                    setUploadPreview(null);
                    setClothingName('');
                    setClothingDescription('');
                  }}
                  className="bg-gray-100 hover:bg-gray-200 text-gray-600 px-6 py-3 rounded-lg font-medium transition-colors"
                >
                  Cancel
                </button>
              </div>

              {/* Pro Tip */}
              <div className="mt-4 p-3 bg-blue-50 rounded-lg">
                <p className="text-xs text-blue-600">
                  üí° <strong>Pro Tip:</strong> Your clothing will be automatically categorized and ready to mix and match with your existing wardrobe!
                </p>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Refresh Mode Modal */}
      {showRefreshModal && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl max-w-md w-full overflow-hidden shadow-2xl">
            <div className="p-6">
              <h3 className="text-xl font-bold text-gray-800 mb-4">Refresh Modes</h3>
              <p className="text-sm text-gray-600 mb-6">Choose how you want to generate new outfit suggestions</p>

              <div className="space-y-3">
                <button
                  onClick={() => {
                    setShowRefreshModal(false);
                    handleSmartRefresh('smart');
                  }}
                  className="w-full flex items-center space-x-3 p-4 rounded-xl border-2 border-blue-200 bg-blue-50 hover:bg-blue-100 transition-colors"
                >
                  <span className="text-2xl">üß†</span>
                  <div className="text-left">
                    <div className="font-semibold text-gray-800">Smart Refresh</div>
                    <div className="text-sm text-gray-600">AI learns from your preferences</div>
                  </div>
                </button>

                <button
                  onClick={() => {
                    setShowRefreshModal(false);
                    handleSmartRefresh('seasonal');
                  }}
                  className="w-full flex items-center space-x-3 p-4 rounded-xl border-2 border-green-200 bg-green-50 hover:bg-green-100 transition-colors"
                >
                  <span className="text-2xl">üå±</span>
                  <div className="text-left">
                    <div className="font-semibold text-gray-800">Seasonal Focus</div>
                    <div className="text-sm text-gray-600">Perfect for current season</div>
                  </div>
                </button>

                <button
                  onClick={() => {
                    setShowRefreshModal(false);
                    handleSmartRefresh('color');
                  }}
                  className="w-full flex items-center space-x-3 p-4 rounded-xl border-2 border-purple-200 bg-purple-50 hover:bg-purple-100 transition-colors"
                >
                  <span className="text-2xl">üé®</span>
                  <div className="text-left">
                    <div className="font-semibold text-gray-800">Color Harmony</div>
                    <div className="text-sm text-gray-600">Focus on color coordination</div>
                  </div>
                </button>

                <button
                  onClick={() => {
                    setShowRefreshModal(false);
                    handleSmartRefresh('occasion');
                  }}
                  className="w-full flex items-center space-x-3 p-4 rounded-xl border-2 border-orange-200 bg-orange-50 hover:bg-orange-100 transition-colors"
                >
                  <span className="text-2xl">üéØ</span>
                  <div className="text-left">
                    <div className="font-semibold text-gray-800">Occasion Based</div>
                    <div className="text-sm text-gray-600">Outfits for specific events</div>
                  </div>
                </button>
              </div>

              <div className="mt-6 flex justify-end">
                <button
                  onClick={() => setShowRefreshModal(false)}
                  className="bg-gray-100 hover:bg-gray-200 text-gray-600 px-6 py-2 rounded-lg font-medium transition-colors"
                >
                  Cancel
                </button>
              </div>

              {/* User Preferences Summary */}
              {(userPreferences.preferredStyles.length > 0 || userPreferences.preferredColors.length > 0) && (
                <div className="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                  <p className="text-xs font-semibold text-blue-800 mb-2">Your Learned Preferences:</p>
                  {userPreferences.preferredStyles.length > 0 && (
                    <p className="text-xs text-blue-700">
                      <strong>Styles:</strong> {userPreferences.preferredStyles.slice(0, 3).join(', ')}
                    </p>
                  )}
                  {userPreferences.preferredColors.length > 0 && (
                    <p className="text-xs text-blue-700">
                      <strong>Colors:</strong> {userPreferences.preferredColors.slice(0, 4).join(', ')}
                    </p>
                  )}
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      {/* Image Selection Modal */}
      {showImageSelection && multipleOutfitImages && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
            <div className="p-6">
              <div className="text-center mb-6">
                <h2 className="text-2xl font-bold text-gray-800 mb-2">
                  ‚ú® Choose Your Favorite Style
                </h2>
                <p className="text-gray-600">
                  We generated {multipleOutfitImages.length} variations for you. Pick the one you like best!
                </p>
              </div>

              {/* Image Grid */}
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                {multipleOutfitImages.map((image, index) => (
                  <div
                    key={index}
                    onClick={() => handleImageSelection(image)}
                    className="group cursor-pointer transform transition-all duration-300 hover:scale-105 hover:shadow-xl"
                  >
                    <div className="relative bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl overflow-hidden border-2 border-gray-200 group-hover:border-purple-400">
                      {/* Image */}
                      <div className="aspect-square bg-white">
                        <img
                          src={image.url}
                          alt={`${image.variation} style`}
                          className="w-full h-full object-cover"
                          onError={(e) => {
                            // Fallback for broken images
                            e.target.style.display = 'none';
                            e.target.nextSibling.style.display = 'flex';
                          }}
                        />
                        <div
                          className="hidden w-full h-full items-center justify-center bg-gray-100 text-gray-500"
                          style={{ display: 'none' }}
                        >
                          <span className="text-sm">Preview Unavailable</span>
                        </div>
                      </div>

                      {/* Overlay */}
                      <div className="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all duration-300 flex items-end">
                        <div className="w-full p-4 bg-gradient-to-t from-black/70 to-transparent text-white opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                          <div className="font-semibold">{image.variation}</div>
                          <div className="text-xs opacity-90">Click to select</div>
                        </div>
                      </div>

                      {/* Style Badge */}
                      <div className="absolute top-3 left-3">
                        <span className="bg-white/90 text-gray-800 px-3 py-1 rounded-full text-xs font-medium shadow-sm">
                          {image.variation}
                        </span>
                      </div>
                    </div>
                  </div>
                ))}
              </div>

              {/* Action Buttons */}
              <div className="flex justify-between items-center border-t pt-4">
                <button
                  onClick={() => setShowImageSelection(false)}
                  className="px-6 py-2 text-gray-600 hover:text-gray-800 font-medium transition-colors"
                >
                  Cancel
                </button>

                <div className="text-sm text-gray-500">
                  üí° Your choice helps us learn your preferences
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Web-Enhanced Prompt Modal */}
      <WebEnhancedPromptModal
        isOpen={showWebEnhancedModal}
        onClose={() => setShowWebEnhancedModal(false)}
        variations={webEnhancedVariations}
        onSelectVariation={handleSelectWebEnhancedVariation}
        isLoading={isGeneratingWebVariations}
        originalPrompt={outfitPrompt}
      />

      {/* Save to Closet Modal */}
      <SaveToClosetModal
        isOpen={showSaveToClosetModal}
        onClose={() => setShowSaveToClosetModal(false)}
        generatedImageUrl={pendingSaveImage || ''}
        originalPrompt={pendingSavePrompt}
        onSaveToCloset={handleSaveToCloset}
        onAddToWishlist={handleAddToWishlist}
      />

      {/* Wishlist Modal */}
      {activeView === 'wishlist' && (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden shadow-2xl">
            {/* Header */}
            <div className="p-6 border-b border-gray-200 bg-gradient-to-r from-pink-50 to-purple-50">
              <div className="flex items-center justify-between">
                <div className="flex items-center space-x-3">
                  <div className="p-2 bg-pink-100 rounded-lg">
                    <ShoppingCart className="w-6 h-6 text-pink-600" />
                  </div>
                  <div>
                    <h2 className="text-xl font-bold text-gray-800">My Wishlist</h2>
                    <p className="text-sm text-gray-600">
                      {wishlistItems.length === 0 ? 'No items saved yet' : `${wishlistItems.length} item${wishlistItems.length === 1 ? '' : 's'} saved`}
                    </p>
                  </div>
                </div>
                <button
                  onClick={() => setActiveView('closet')}
                  className="p-2 hover:bg-white/80 rounded-lg transition-colors"
                >
                  <span className="w-5 h-5 text-gray-500">‚úï</span>
                </button>
              </div>
            </div>

            {/* Content */}
            <div className="p-6 overflow-y-auto max-h-[calc(90vh-200px)]">
              {wishlistItems.length === 0 ? (
                <div className="text-center py-12">
                  <Heart className="w-16 h-16 text-gray-300 mx-auto mb-4" />
                  <h3 className="text-lg font-semibold text-gray-600 mb-2">Your wishlist is empty</h3>
                  <p className="text-gray-500">Save items when generating outfits to see them here!</p>
                </div>
              ) : (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                  {wishlistItems.map((item) => (
                    <div key={item.id} className="bg-white border border-gray-200 rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-shadow">
                      {/* Image */}
                      <div className="relative h-48 bg-gray-100">
                        <img
                          src={item.imageUrl}
                          alt={item.name || 'Wishlist item'}
                          className="w-full h-full object-cover"
                          onError={(e) => {
                            (e.target as HTMLImageElement).style.display = 'none';
                          }}
                        />
                      </div>

                      {/* Content */}
                      <div className="p-4">
                        <h4 className="font-semibold text-gray-800 mb-2 line-clamp-2">
                          {item.name || item.notes || 'Untitled Item'}
                        </h4>
                        <p className="text-sm text-gray-600 mb-3 line-clamp-2">
                          {item.fromPrompt}
                        </p>
                        <p className="text-xs text-gray-500 mb-4">
                          Added {new Date(item.dateAdded).toLocaleDateString()}
                        </p>

                        {/* Action Buttons */}
                        <div className="flex space-x-2">
                          <button
                            onClick={() => handleMoveToCloset(item)}
                            className="flex-1 flex items-center justify-center space-x-1 bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-2 rounded-lg text-sm font-medium transition-colors"
                            title="Move to Closet"
                          >
                            <ArrowRightCircle className="w-3 h-3" />
                            <span>Move</span>
                          </button>
                          <button
                            onClick={() => handleGenerateSimilar(item)}
                            className="flex-1 flex items-center justify-center space-x-1 bg-green-100 hover:bg-green-200 text-green-700 px-3 py-2 rounded-lg text-sm font-medium transition-colors"
                            title="Generate Similar"
                          >
                            <RotateCcw className="w-3 h-3" />
                            <span>Similar</span>
                          </button>
                          <button
                            onClick={() => handleDeleteWishlistItem(item)}
                            className="flex items-center justify-center bg-red-100 hover:bg-red-200 text-red-700 px-3 py-2 rounded-lg text-sm font-medium transition-colors"
                            title="Delete"
                          >
                            <Trash2 className="w-3 h-3" />
                          </button>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default AvatarHomepage;