import React, { useState, useEffect, useCallback, useMemo } from 'react';
import {
  ArrowLeft,
  Download,
  RotateCcw,
  ZoomIn,
  ZoomOut,
  Settings,
  Star,
  CheckCircle,
  AlertTriangle,
  RefreshCw,
  Wand2,
  Sparkles,
  Loader,
  Eye,
  Edit,
  Palette
} from 'lucide-react';
import { CapturedPhoto, AvatarData, Avatar3DData } from '../types/photo';
import { avatarGenerationService, GenerationProgress, AvatarGenerationResult } from '../services/avatarGenerationService';

interface Avatar3DDisplayProps {
  avatarData: AvatarData;
  capturedPhotos: CapturedPhoto[];
  measurements: any;
  onAdjustMeasurements: () => void;
  onContinueToProfile: () => void;
  onRetakePhotos: () => void;
  onBack: () => void;
}

interface ImageViewerControls {
  zoom: number;
  brightness: number;
  contrast: number;
  saturation: number;
  filter: 'none' | 'sepia' | 'grayscale' | 'vintage' | 'warm';
}

const Avatar3DDisplay: React.FC<Avatar3DDisplayProps> = ({
  avatarData,
  capturedPhotos,
  measurements,
  onAdjustMeasurements,
  onContinueToProfile,
  onRetakePhotos,
  onBack
}) => {
  const [isLoading, setIsLoading] = useState(true);
  const [isGenerating, setIsGenerating] = useState(false);
  const [generationError, setGenerationError] = useState<string | null>(null);
  const [generationProgress, setGenerationProgress] = useState<GenerationProgress | null>(null);
  const [generatedAvatarData, setGeneratedAvatarData] = useState<AvatarData | null>(null);

  // 2D Image controls
  const [imageControls, setImageControls] = useState<ImageViewerControls>({
    zoom: 1,
    brightness: 100,
    contrast: 100,
    saturation: 100,
    filter: 'none'
  });

  const [showControls, setShowControls] = useState(false);

  // Enhanced component mount/state logging
  useEffect(() => {
    console.log('ğŸ¯ Avatar3DDisplay mounted/updated');
    setIsLoading(false);
  }, []);

  // Stabilize measurements to prevent infinite re-renders
  const stableMeasurements = useMemo(() => {
    if (!measurements || typeof measurements !== 'object') return null;
    return { ...measurements };
  }, [measurements && JSON.stringify(measurements)]);

  // Memoize photos to prevent re-renders on array changes
  const stablePhotos = useMemo(() => {
    return capturedPhotos || [];
  }, [capturedPhotos?.length, capturedPhotos?.map(p => p.id).join(',')]);

  // Use callback for generation function to prevent re-creation
  const generateAvatar = useCallback(async () => {
    // Enhanced debug logging
    console.log('ğŸ” 3D Realistic Avatar generation check:', {
      stablePhotos,
      stableMeasurements,
      generatedAvatarData,
      capturedPhotosLength: stablePhotos?.length,
      measurementsType: typeof stableMeasurements,
      measurementsKeys: stableMeasurements ? Object.keys(stableMeasurements) : null,
      hasGeneratedData: !!generatedAvatarData
    });

    // Improved generation condition logic using stable values
    // Photos are optional for 3D realistic generation (text-to-image)
    const hasValidMeasurements = stableMeasurements && typeof stableMeasurements === 'object' && Object.keys(stableMeasurements).length > 0;
    const alreadyGenerated = !!generatedAvatarData;

    if (!hasValidMeasurements || alreadyGenerated) {
      console.log('âŒ Skipping 3D realistic avatar generation:', {
        hasValidMeasurements,
        alreadyGenerated,
        reason: !hasValidMeasurements ? 'No valid measurements' :
                'Avatar already generated'
      });
      return;
    }

    console.log('âœ… Starting 3D realistic avatar generation with:', {
      photoCount: stablePhotos?.length || 0,
      measurements: stableMeasurements,
      capturedPhotos: stablePhotos
    });

    setIsGenerating(true);
    setGenerationError(null);
    setGenerationProgress(null);

    try {
      const result = await avatarGenerationService.generateAvatar(
        stablePhotos,
        stableMeasurements,
        (progress: GenerationProgress) => {
          console.log('ğŸ”„ CGI Generation progress:', progress);
          setGenerationProgress(progress);
        }
      );

      console.log('ğŸ¯ 3D Realistic Generation result:', result);

      if (result.success && result.avatarData) {
        console.log('âœ… 3D Realistic Avatar generation successful!');
        setGeneratedAvatarData(result.avatarData);
        setIsGenerating(false);
      } else {
        console.log('âŒ 3D Realistic Avatar generation failed:', result.error);
        setGenerationError(result.error || '3D Realistic Avatar generation failed');
        setIsGenerating(false);
      }
    } catch (error) {
      console.error('ğŸ’¥ 3D Realistic Avatar generation error:', error);
      setGenerationError(error instanceof Error ? error.message : '3D Realistic Avatar generation failed');
      setIsGenerating(false);
    }
  }, [stablePhotos, stableMeasurements, generatedAvatarData, isGenerating]);

  // Start avatar generation when component loads
  useEffect(() => {
    console.log('ğŸ” Avatar3DDisplay generation useEffect triggered');
    console.log('ğŸ“¸ stablePhotos (optional for 3D):', stablePhotos);
    console.log('ğŸ“ stableMeasurements:', stableMeasurements);

    // Only generate if we have measurements and haven't already started
    if (stableMeasurements && !isGenerating && !generatedAvatarData) {
      console.log('ğŸš€ Triggering 3D realistic avatar generation');
      generateAvatar();
    }
  }, [generateAvatar, isGenerating]);

  // Get the current avatar image URL - only return if we have a generated image
  const getCurrentImageUrl = (): string | null => {
    const currentData = generatedAvatarData || avatarData;
    // Only return actual generated images, not placeholders
    return currentData?.imageUrl || null;
  };

  // Check if we have a valid generated image
  const hasGeneratedImage = (): boolean => {
    const imageUrl = getCurrentImageUrl();
    return imageUrl !== null && !imageUrl.includes('/portrait/my-new-portrait.png');
  };

  // Apply image filters and adjustments
  const getImageStyle = (): React.CSSProperties => {
    const { zoom, brightness, contrast, saturation, filter } = imageControls;

    let filterString = `brightness(${brightness}%) contrast(${contrast}%) saturate(${saturation}%)`;

    switch (filter) {
      case 'sepia':
        filterString += ' sepia(0.8)';
        break;
      case 'grayscale':
        filterString += ' grayscale(1)';
        break;
      case 'vintage':
        filterString += ' sepia(0.3) contrast(1.2) brightness(1.1)';
        break;
      case 'warm':
        filterString += ' sepia(0.2) saturate(1.3) hue-rotate(10deg)';
        break;
    }

    return {
      transform: `scale(${zoom})`,
      filter: filterString,
      transition: 'all 0.3s ease'
    };
  };

  // Handle image download
  const handleDownload = async () => {
    const imageUrl = getCurrentImageUrl();
    if (!imageUrl) {
      console.warn('No image available for download');
      return;
    }

    try {
      const response = await fetch(imageUrl);
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `3d-realistic-avatar-${Date.now()}.png`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      window.URL.revokeObjectURL(url);
    } catch (error) {
      console.error('Download failed:', error);
    }
  };

  // Reset image controls
  const resetControls = () => {
    setImageControls({
      zoom: 1,
      brightness: 100,
      contrast: 100,
      saturation: 100,
      filter: 'none'
    });
  };

  return (
    <div className="min-h-screen flex flex-col px-6 py-8 bg-gradient-to-br from-purple-50 to-pink-50">
      {/* Header */}
      <div className="flex items-center justify-between mb-8">
        <button
          onClick={onBack}
          className="p-2 hover:bg-white/50 rounded-full transition-colors"
        >
          <ArrowLeft className="w-6 h-6 text-gray-600" />
        </button>
        <h1 className="text-2xl font-bold text-gray-800">Your 3D Realistic Avatar</h1>
        <div className="w-10 h-10" />
      </div>

      {/* Generation Status Indicator */}
      {isGenerating && (
        <div className="mb-6 bg-blue-50 border border-blue-200 rounded-xl p-4">
          <div className="flex items-center space-x-3">
            <Loader className="w-5 h-5 text-blue-600 animate-spin" />
            <div className="flex-1">
              <p className="text-blue-800 font-medium">
                {generationProgress?.stage || 'Transforming your photos into CGI avatar...'}
              </p>
              {generationProgress && (
                <div className="mt-2">
                  <div className="bg-blue-200 rounded-full h-2">
                    <div
                      className="bg-blue-600 rounded-full h-2 transition-all duration-300"
                      style={{ width: `${generationProgress.progress}%` }}
                    />
                  </div>
                  <p className="text-blue-600 text-sm mt-1">{generationProgress.message}</p>
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      {/* Error Display */}
      {generationError && (
        <div className="mb-6 bg-red-50 border border-red-200 rounded-xl p-4">
          <div className="flex items-center space-x-3">
            <AlertTriangle className="w-5 h-5 text-red-600" />
            <div>
              <p className="text-red-800 font-medium">Generation Error</p>
              <p className="text-red-600 text-sm">{generationError}</p>
            </div>
          </div>
        </div>
      )}

      {/* Main Avatar Display */}
      <div className="flex-1 flex flex-col items-center justify-center mb-8">
        <div className="relative bg-white rounded-3xl shadow-2xl p-8 max-w-lg w-full">
          {/* Image Container */}
          <div className="relative overflow-hidden rounded-2xl bg-gray-100 aspect-square">
            {hasGeneratedImage() ? (
              // Show generated image
              <>
                <img
                  src={getCurrentImageUrl()!}
                  alt="Your 3D Realistic Avatar"
                  className="w-full h-full object-cover cursor-pointer"
                  style={getImageStyle()}
                  onClick={() => setShowControls(!showControls)}
                />

                {/* Zoom Indicator */}
                {imageControls.zoom !== 1 && (
                  <div className="absolute top-4 left-4 bg-black/50 text-white px-2 py-1 rounded text-sm">
                    {Math.round(imageControls.zoom * 100)}%
                  </div>
                )}
              </>
            ) : (
              // Show empty state
              <div className="w-full h-full flex items-center justify-center bg-gray-50 border-2 border-dashed border-gray-300">
                <div className="text-center p-8">
                  {isGenerating ? (
                    <>
                      <Loader className="w-12 h-12 text-purple-600 animate-spin mx-auto mb-4" />
                      <h3 className="text-lg font-medium text-gray-700 mb-2">
                        Transforming Your Photos into Personalized CGI Avatar
                      </h3>
                      <p className="text-gray-500 text-sm">
                        {generationProgress?.message || 'Converting your photos into photorealistic 3D CGI while preserving your likeness...'}
                      </p>
                      <p className="text-blue-600 text-xs mt-1">
                        ğŸ­ Photo-to-CGI Transformation â€¢ Human Likeness Preserved â€¢ Full-Body Rendering
                      </p>
                    </>
                  ) : (
                    <>
                      <Sparkles className="w-12 h-12 text-gray-400 mx-auto mb-4" />
                      <h3 className="text-lg font-medium text-gray-700 mb-2">
                        Your Photo-to-CGI Personalized Avatar Will Appear Here
                      </h3>
                      <p className="text-gray-500 text-sm">
                        Click "Transform to CGI Avatar" below to convert your photos into a photorealistic 3D CGI character
                      </p>
                      <p className="text-blue-600 text-xs mt-1">
                        ğŸ­ Preserves your unique likeness â€¢ Full-body CGI transformation â€¢ Ready for virtual try-on
                      </p>
                    </>
                  )}
                </div>
              </div>
            )}

            {/* Image Controls Overlay - Only show when image exists */}
            {hasGeneratedImage() && showControls && (
              <div className="absolute inset-0 bg-black/50 flex items-center justify-center">
                <div className="bg-white rounded-xl p-6 max-w-sm w-full mx-4">
                  <h3 className="font-medium text-gray-800 mb-4">Image Controls</h3>

                  {/* Zoom */}
                  <div className="mb-4">
                    <label className="block text-sm text-gray-600 mb-2">Zoom: {Math.round(imageControls.zoom * 100)}%</label>
                    <input
                      type="range"
                      min="0.5"
                      max="3"
                      step="0.1"
                      value={imageControls.zoom}
                      onChange={(e) => setImageControls(prev => ({ ...prev, zoom: parseFloat(e.target.value) }))}
                      className="w-full"
                    />
                  </div>

                  {/* Brightness */}
                  <div className="mb-4">
                    <label className="block text-sm text-gray-600 mb-2">Brightness: {imageControls.brightness}%</label>
                    <input
                      type="range"
                      min="50"
                      max="150"
                      value={imageControls.brightness}
                      onChange={(e) => setImageControls(prev => ({ ...prev, brightness: parseInt(e.target.value) }))}
                      className="w-full"
                    />
                  </div>

                  {/* Contrast */}
                  <div className="mb-4">
                    <label className="block text-sm text-gray-600 mb-2">Contrast: {imageControls.contrast}%</label>
                    <input
                      type="range"
                      min="50"
                      max="150"
                      value={imageControls.contrast}
                      onChange={(e) => setImageControls(prev => ({ ...prev, contrast: parseInt(e.target.value) }))}
                      className="w-full"
                    />
                  </div>

                  {/* Filter Presets */}
                  <div className="mb-4">
                    <label className="block text-sm text-gray-600 mb-2">Filter</label>
                    <select
                      value={imageControls.filter}
                      onChange={(e) => setImageControls(prev => ({ ...prev, filter: e.target.value as any }))}
                      className="w-full p-2 border rounded"
                    >
                      <option value="none">None</option>
                      <option value="sepia">Sepia</option>
                      <option value="grayscale">Grayscale</option>
                      <option value="vintage">Vintage</option>
                      <option value="warm">Warm</option>
                    </select>
                  </div>

                  {/* Control Buttons */}
                  <div className="flex space-x-2">
                    <button
                      onClick={resetControls}
                      className="flex-1 bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-colors"
                    >
                      Reset
                    </button>
                    <button
                      onClick={() => setShowControls(false)}
                      className="flex-1 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors"
                    >
                      Done
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>

          {/* Action Buttons - Only show when image exists */}
          {hasGeneratedImage() && (
            <div className="flex justify-center space-x-4 mt-6">
              <button
                onClick={handleDownload}
                className="flex items-center space-x-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors"
              >
                <Download className="w-4 h-4" />
                <span>Download</span>
              </button>

              <button
                onClick={() => setShowControls(true)}
                className="flex items-center space-x-2 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors"
              >
                <Edit className="w-4 h-4" />
                <span>Edit</span>
              </button>
            </div>
          )}
        </div>

        {/* Manual Generation Button */}
        <div className="mt-6">
          <button
            onClick={async () => {
              try {
                console.log('ğŸ”„ Manual 3D realistic generation triggered');
                setGeneratedAvatarData(null); // Reset to trigger regeneration
                setIsGenerating(false);

                // Wait a moment then trigger generation
                setTimeout(() => {
                  generateAvatar();
                }, 100);
              } catch (error) {
                console.error('ğŸ’¥ Manual 3D realistic generation failed:', error);
                setGenerationError('Manual generation failed: ' + (error instanceof Error ? error.message : 'Unknown error'));
              }
            }}
            disabled={isGenerating}
            className="flex items-center space-x-2 bg-blue-600 text-white px-6 py-3 rounded-xl hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300 shadow-lg hover:shadow-xl"
          >
            <RefreshCw className={`w-5 h-5 ${isGenerating ? 'animate-spin' : ''}`} />
            <span>{isGenerating ? 'Transforming...' : 'Transform to CGI Avatar'}</span>
          </button>
        </div>
      </div>

      {/* Debug Status Panel */}
      <div className="bg-white rounded-xl p-4 border border-gray-200 mb-6">
        <div className="font-medium text-gray-700 mb-2">Debug Status:</div>
        <div className="text-sm text-gray-600 space-y-1">
          <div>ğŸ“¸ Photos: {stablePhotos?.length || 0}</div>
          <div>ğŸ“ Measurements: {stableMeasurements ? 'âœ…' : 'âŒ'}</div>
          <div>ğŸ¨ Generated: {generatedAvatarData ? 'âœ…' : 'âŒ'}</div>
          <div>âš™ï¸ Generating: {isGenerating ? 'âœ…' : 'âŒ'}</div>
          <div>âŒ Error: {generationError ? generationError : 'None'}</div>
          {generatedAvatarData?.metadata && (
            <>
              <div>ğŸ” Style: {generatedAvatarData.metadata.style || 'Unknown'}</div>
              <div>ğŸ¤– Model: {generatedAvatarData.metadata.model || 'Unknown'}</div>
              <div>ğŸ“ Perspective: {generatedAvatarData.metadata.perspective || 'Unknown'}</div>
              <div>ğŸ’¡ Lighting: {generatedAvatarData.metadata.lighting || 'Unknown'}</div>
              {generatedAvatarData.metadata.personalization && (
                <div>ğŸ‘¤ Personalization: {generatedAvatarData.metadata.personalization === 'photos_used' ? 'âœ… Photos Used' : 'âŒ Fallback'}</div>
              )}
              {generatedAvatarData.metadata.reference_photos_count !== undefined && (
                <div>ğŸ“¸ Reference Photos: {generatedAvatarData.metadata.reference_photos_count}</div>
              )}
              {generatedAvatarData.metadata.cgi_preset && (
                <div>ğŸ¬ CGI Quality: {generatedAvatarData.metadata.cgi_preset.replace('_', ' ').toUpperCase()}</div>
              )}
              {generatedAvatarData.metadata.cgi_features && (
                <div>ğŸ”§ CGI Features: {generatedAvatarData.metadata.cgi_features.slice(0, 3).join(', ')}</div>
              )}
            </>
          )}
        </div>

        {/* Debug API Test Buttons */}
        <div className="mt-4 pt-4 border-t border-gray-200">
          <div className="font-medium text-gray-700 mb-2">API Debug Tools:</div>
          <div className="flex flex-wrap gap-2">
            <button
              onClick={() => {
                console.log('ğŸ”§ Environment Config Debug:', {
                  mode: import.meta.env.VITE_AVATAR_GENERATION_MODE,
                  modelType: import.meta.env.VITE_AVATAR_MODEL_TYPE,
                  style: import.meta.env.VITE_DEFAULT_AVATAR_STYLE,
                  perspective: import.meta.env.VITE_DEFAULT_AVATAR_PERSPECTIVE,
                  // PhotoMaker Config
                  photoMakerModel: import.meta.env.VITE_PHOTOMAKER_MODEL_ID,
                  photoMakerStyle: import.meta.env.VITE_PHOTOMAKER_DEFAULT_STYLE,
                  photoMakerStyleStrength: import.meta.env.VITE_PHOTOMAKER_STYLE_STRENGTH,
                  // CGI Enhancement Config
                  cgiQualityPreset: import.meta.env.VITE_CGI_QUALITY_PRESET,
                  cgiEnhancementEnabled: import.meta.env.VITE_ENABLE_CGI_ENHANCEMENT,
                  // Nano Banana Config
                  nanoBananaModel: import.meta.env.VITE_NANO_BANANA_MODEL_ID,
                  // API Settings
                  hasApiKey: !!import.meta.env.VITE_FAL_KEY,
                  developmentMode: import.meta.env.VITE_DEVELOPMENT_MODE,
                  forceProductionApi: import.meta.env.VITE_FORCE_PRODUCTION_API
                });
              }}
              className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200"
            >
              Log Config
            </button>
            <button
              onClick={() => {
                console.log('ğŸ¯ Current Avatar Data:', generatedAvatarData);
                console.log('ğŸ“ Current Measurements:', stableMeasurements);
                console.log('ğŸ“¸ Current Photos:', stablePhotos);
              }}
              className="text-xs bg-green-100 text-green-700 px-2 py-1 rounded hover:bg-green-200"
            >
              Log Data
            </button>
            <button
              onClick={() => {
                setGeneratedAvatarData(null);
                setGenerationError(null);
                console.log('ğŸ”„ Reset avatar data for fresh generation');
              }}
              className="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded hover:bg-orange-200"
            >
              Reset Data
            </button>
          </div>
        </div>
      </div>

      {/* Navigation Buttons */}
      <div className="flex space-x-4">
        <button
          onClick={onRetakePhotos}
          className="flex-1 bg-gray-100 text-gray-700 py-3 px-6 rounded-xl hover:bg-gray-200 transition-colors"
        >
          Retake Photos
        </button>

        <button
          onClick={onAdjustMeasurements}
          className="flex-1 bg-gray-100 text-gray-700 py-3 px-6 rounded-xl hover:bg-gray-200 transition-colors"
        >
          Adjust Measurements
        </button>

        <button
          onClick={onContinueToProfile}
          disabled={!hasGeneratedImage()}
          className="flex-1 bg-purple-600 text-white py-3 px-6 rounded-xl hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
        >
          Continue to Profile
        </button>
      </div>
    </div>
  );
};

export default Avatar3DDisplay;